<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-card: #ffffff;
            --text: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s;
        }

        .logo {
            padding: 0 24px 24px;
            font-size: 1.6em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-title {
            padding: 0 24px;
            font-size: 0.7em;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .nav-item {
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            font-size: 1.1em;
        }

        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .nav-item.active {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, transparent 100%);
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        /* MAIN CONTENT */
        .main {
            flex: 1;
            margin-left: 280px;
            padding: 32px;
            max-width: calc(100vw - 280px);
        }

        .page {
            display: none;
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* HEADER */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 2.2em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        /* CARDS */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 1px 3px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 4px 12px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 700;
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--info));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* GRID */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        /* FORMS */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1em;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* TABLE */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-secondary);
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.95em;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        /* BADGES */
        .badge {
            display: inline-flex;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            color: var(--success);
            border: 1px solid var(--success);
        }

        .badge.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .badge.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.15));
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .badge.info {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(79, 70, 229, 0.15));
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        /* MATCH CARDS - TheSportsDB */
        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 14px;
        }

        .match-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .match-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--info));
            opacity: 0;
            transition: opacity 0.25s;
        }

        .match-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .match-card:hover::before {
            opacity: 1;
        }

        .match-card-league {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 0.78em;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .match-card-league img {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            object-fit: contain;
        }

        .match-card-teams {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .match-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            flex: 1;
            text-align: center;
        }

        .match-team img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .match-team-name {
            font-weight: 700;
            font-size: 0.85em;
            line-height: 1.2;
        }

        .match-vs {
            font-weight: 800;
            color: var(--text-secondary);
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .match-score {
            font-size: 1.4em;
            font-weight: 800;
            color: var(--primary);
            flex-shrink: 0;
            min-width: 60px;
            text-align: center;
        }

        .match-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            padding-top: 10px;
        }

        .match-time {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .match-status-live {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85em;
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger);
            animation: pulseLive 1.5s infinite;
        }

        @keyframes pulseLive {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .match-status-live::before {
            content: '';
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--danger);
        }

        .match-status-finished {
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85em;
            background: rgba(16, 185, 129, 0.12);
            color: var(--success);
        }

        .match-status-upcoming {
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85em;
            background: rgba(99, 102, 241, 0.12);
            color: var(--primary);
        }

        .match-use-btn {
            font-size: 0.78em;
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .match-card:hover .match-use-btn {
            opacity: 1;
        }

        .matches-date-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .matches-date-nav button {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .matches-date-nav button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .matches-date-label {
            font-weight: 700;
            font-size: 0.95em;
            color: var(--text);
        }

        /* CHARTS */
        .chart-container {
            position: relative;
            height: 320px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.7em;
            font-weight: 800;
        }

        .close-modal {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            color: var(--text);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 28px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 14px 24px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text);
            background: var(--bg-secondary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* BANKROLL SELECTOR */
        .bankroll-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .bankroll-item {
            padding: 12px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.95em;
        }

        .bankroll-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .bankroll-item.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* FILTERS */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filters select {
            flex: 1;
            min-width: 200px;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 1.1em;
            font-weight: 500;
        }

        /* COMBINED BET */
        .combined-match {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .combined-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .combined-title {
            font-weight: 700;
            color: var(--primary);
        }

        /* SWITCH */
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary), var(--info));
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* RESPONSIVE */
        /* MOBILE HEADER */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            z-index: 98;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .hamburger {
            width: 42px;
            height: 42px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .hamburger span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--text);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .hamburger.active span:nth-child(1) {
            transform: translateY(7px) rotate(45deg);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: translateY(-7px) rotate(-45deg);
        }

        .mobile-logo {
            font-size: 1.2em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .mobile-add-btn {
            width: 42px;
            height: 42px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: 1fr; }
        }

        @media (max-width: 968px) {
            .grid-2 { grid-template-columns: 1fr; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
                box-shadow: 4px 0 24px rgba(0,0,0,0.3);
            }
            
            .main {
                margin-left: 0;
                max-width: 100vw;
                padding: 16px;
                padding-top: 70px;
            }

            .page-title {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .mobile-header {
                display: flex !important;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 99;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .card {
                padding: 18px;
            }

            .matches-grid {
                grid-template-columns: 1fr;
            }

            .match-use-btn {
                opacity: 1;
            }

            .table-container {
                font-size: 0.85em;
            }

            td, th {
                padding: 10px 8px;
            }

            .modal-content {
                padding: 20px;
                border-radius: 16px;
            }

            .bankroll-selector {
                flex-direction: column;
            }

            .tabs {
                gap: 4px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 0.9em;
            }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        /* CUSTOM CONFIRM */

        /* STATUS DROPDOWN */
        .status-wrapper {
            position: relative;
            display: inline-block;
        }

        .status-badge {
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .status-badge:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .status-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 500;
            min-width: 140px;
            overflow: hidden;
            animation: confirmIn 0.15s ease-out;
        }

        .status-dropdown.open {
            display: block;
        }

        .status-option {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
            color: var(--text);
        }

        .status-option:hover {
            background: var(--bg-secondary);
        }

        .status-option .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .badge.cashout {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
            color: var(--info);
            border: 1px solid var(--info);
        }

        /* CUSTOM CONFIRM */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(6px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 36px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            animation: confirmIn 0.25s ease-out;
        }

        @keyframes confirmIn {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .confirm-icon {
            font-size: 3em;
            margin-bottom: 16px;
        }

        .confirm-title {
            font-size: 1.3em;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }

        .confirm-message {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 28px;
            line-height: 1.5;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .confirm-cancel {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .confirm-cancel:hover {
            background: var(--border);
        }

        .confirm-ok {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .confirm-ok:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body data-theme="light">
    <!-- MOBILE HEADER -->
    <div class="mobile-header">
        <button class="hamburger" id="hamburgerBtn" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <span class="mobile-logo">Bet Tracker Pro</span>
        <button class="mobile-add-btn" onclick="openModal('addBetModal')">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- SIDEBAR OVERLAY -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

    <div class="app">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                Bet Tracker Pro
            </div>
            
            <nav>
                <div class="nav-section">
                    <div class="nav-title">Principal</div>
                    <div class="nav-item active" data-page="dashboard">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </div>
                    <div class="nav-item" data-page="bets">
                        <i class="fas fa-list"></i>
                        Mes Paris
                    </div>
                    <div class="nav-item" data-page="analyzer">
                        <i class="fas fa-microscope"></i>
                        Analyzer
                    </div>
                    <div class="nav-item" data-page="optimizer">
                        <i class="fas fa-sliders-h"></i>
                        Optimizer
                    </div>
                    <div class="nav-item" data-page="pronostics">
                        <i class="fas fa-bullseye"></i>
                        Pronostics
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Gestion</div>
                    <div class="nav-item" data-page="bankrolls">
                        <i class="fas fa-wallet"></i>
                        Bankrolls
                    </div>
                    <div class="nav-item" data-page="settings">
                        <i class="fas fa-cog"></i>
                        Param√®tres
                    </div>
                </div>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main">
            <!-- DASHBOARD -->
            <div class="page active" id="dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="header-actions">
                        <button class="theme-toggle" id="themeToggle">üåô</button>
                        <button class="btn" onclick="openModal('addBetModal')">
                            <i class="fas fa-plus"></i>
                            Nouveau Pari
                        </button>
                    </div>
                </div>

                <div class="bankroll-selector" id="bankrollSelector"></div>
                <div class="stats-grid" id="statsGrid"></div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">√âvolution Bankroll</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="bankrollChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">R√©partition Gains/Pertes</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="winLossChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Derniers Paris</h3>
                    </div>
                    <div id="recentBetsTable"></div>
                </div>
            </div>

            <!-- BETS -->
            <div class="page" id="bets">
                <div class="page-header">
                    <h1 class="page-title">Mes Paris</h1>
                    <button class="btn" onclick="openModal('addBetModal')">
                        <i class="fas fa-plus"></i>
                        Nouveau Pari
                    </button>
                </div>

                <div class="bankroll-selector" id="bankrollSelectorBets"></div>

                <div class="card">
                    <div class="filters">
                        <select id="filterType">
                            <option value="">Type</option>
                            <option value="simple">Simple</option>
                            <option value="combine">Combin√©</option>
                            <option value="systeme">Syst√®me</option>
                        </select>
                        <select id="filterSport">
                            <option value="">Sport</option>
                        </select>
                        <select id="filterStatus">
                            <option value="">Statut</option>
                            <option value="en-cours">En cours</option>
                            <option value="gagne">Gagn√©</option>
                            <option value="perdu">Perdu</option>
                            <option value="cashout">Cashout</option>
                        </select>
                        <select id="filterBookmaker">
                            <option value="">Bookmaker</option>
                        </select>
                    </div>

                    <div id="betsTable"></div>
                </div>
            </div>

            <!-- ANALYZER -->
            <div class="page" id="analyzer">
                <div class="page-header">
                    <h1 class="page-title">Analyzer</h1>
                </div>

                <div class="bankroll-selector" id="bankrollSelectorAnalyzer"></div>
                <div class="stats-grid" id="analyzerStats"></div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Performance par Sport</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="sportChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Performance par Bookmaker</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="bookmakerChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ROI par Confiance</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="confidenceChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ROI par Cote</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="oddsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OPTIMIZER -->
            <div class="page" id="optimizer">
                <div class="page-header">
                    <h1 class="page-title">Optimizer</h1>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3 class="card-title">Strat√©gie de Mise</h3>
                        <form id="strategyForm">
                            <div class="form-group">
                                <label>Type de Strat√©gie</label>
                                <select id="strategyType">
                                    <option value="flat">Flat Betting</option>
                                    <option value="percentage">% Bankroll</option>
                                    <option value="kelly">Kelly Criterion</option>
                                </select>
                            </div>

                            <div class="form-group" id="flatAmount" style="display:none;">
                                <label>Mise Fixe (‚Ç¨)</label>
                                <input type="number" step="0.01" id="flatValue">
                            </div>

                            <div class="form-group" id="percentageAmount" style="display:none;">
                                <label>% Bankroll</label>
                                <input type="number" step="0.1" id="percentageValue" value="2">
                            </div>

                            <button type="submit" class="btn">Calculer</button>
                        </form>

                        <div id="strategyResult"></div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Simulation</h3>
                        <form id="simForm">
                            <div class="form-group">
                                <label>Nombre de Paris</label>
                                <input type="number" id="simBets" value="100" min="10">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Taux R√©ussite (%)</label>
                                    <input type="number" id="simWinRate" value="55" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label>Cote Moyenne</label>
                                    <input type="number" step="0.01" id="simOdds" value="2.0">
                                </div>
                            </div>

                            <button type="submit" class="btn">Simuler</button>
                        </form>

                        <div class="chart-container" style="margin-top: 24px;">
                            <canvas id="simChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRONOSTICS -->
            <div class="page" id="pronostics">
                <div class="page-header">
                    <h1 class="page-title">Pronostics</h1>
                </div>

                <!-- MATCHS DU JOUR - TheSportsDB -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-calendar-day" style="color: var(--primary); margin-right: 8px;"></i>Matchs du Jour</h3>
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <select id="liveSportFilter" style="width: auto; padding: 8px 14px; font-size: 0.85em; border-radius: 10px;">
                                <option value="all">Tous les sports</option>
                                <option value="soccer">‚öΩ Football</option>
                                <option value="basketball">üèÄ Basketball</option>
                                <option value="tennis">üéæ Tennis</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="loadTodayMatches()" id="refreshMatchesBtn">
                                <i class="fas fa-sync-alt"></i> Actualiser
                            </button>
                        </div>
                    </div>
                    <div id="todayMatchesContainer">
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <div style="font-size: 2.5em; margin-bottom: 12px;">‚öΩ</div>
                            <p style="font-weight: 600; margin-bottom: 8px;">Chargement des matchs du jour...</p>
                            <p style="font-size: 0.85em;">Connexion √† TheSportsDB...</p>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3 class="card-title">Analyser un Match</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 20px;">
                            Bas√© sur votre historique de paris personnel ‚Äî ou cliquez sur un match ci-dessus pour pr√©-remplir
                        </p>

                        <div class="form-group">
                            <label>Sport</label>
                            <select id="pronoSport">
                                <option value="Football">Football</option>
                                <option value="Basketball">Basketball</option>
                                <option value="Tennis">Tennis</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ligue / Comp√©tition</label>
                            <input type="text" id="pronoLeague" placeholder="Ex: Ligue 1, NBA, ATP...">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>√âquipe / Joueur 1</label>
                                <input type="text" id="pronoTeam1" placeholder="Ex: PSG, Djokovic...">
                            </div>
                            <div class="form-group">
                                <label>√âquipe / Joueur 2</label>
                                <input type="text" id="pronoTeam2" placeholder="Ex: OM, Nadal...">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Type de Pari</label>
                                <select id="pronoType">
                                    <option value="1">Victoire √âquipe/Joueur 1</option>
                                    <option value="N">Match Nul</option>
                                    <option value="2">Victoire √âquipe/Joueur 2</option>
                                    <option value="1X">1 ou Nul</option>
                                    <option value="X2">Nul ou 2</option>
                                    <option value="o2.5">Plus de 2.5 buts/sets</option>
                                    <option value="u2.5">Moins de 2.5 buts/sets</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cote propos√©e</label>
                                <input type="number" step="0.01" id="pronoOdds" placeholder="1.85">
                            </div>
                        </div>

                        <button class="btn" onclick="analyzeProno()" style="width: 100%;">
                            <i class="fas fa-search"></i> Analyser
                        </button>

                        <div id="pronoResult"></div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Vos Points Forts</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 20px;">
                            L√† o√π vous performez le mieux
                        </p>
                        <div id="pronoStrengths"></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h3 class="card-title">Recommandations Personnalis√©es</h3>
                    <div id="pronoRecommendations"></div>
                </div>
            </div>

            <!-- BANKROLLS -->
            <div class="page" id="bankrolls">
                <div class="page-header">
                    <h1 class="page-title">Mes Bankrolls</h1>
                    <button class="btn" onclick="openModal('addBankrollModal')">
                        <i class="fas fa-plus"></i>
                        Nouvelle Bankroll
                    </button>
                </div>

                <div class="grid-3" id="bankrollsList"></div>
            </div>

            <!-- SETTINGS -->
            <div class="page" id="settings">
                <div class="page-header">
                    <h1 class="page-title">Param√®tres</h1>
                </div>

                <div class="card">
                    <h3 class="card-title">G√©n√©ral</h3>
                    
                    <div class="form-group">
                        <label style="display: flex; justify-content: space-between; align-items: center;">
                            Mode Sombre
                            <label class="switch">
                                <input type="checkbox" id="darkModeSwitch">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Devise</label>
                        <select id="currency">
                            <option value="EUR">Euro (‚Ç¨)</option>
                            <option value="USD">Dollar ($)</option>
                            <option value="GBP">Livre (¬£)</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Exporter Donn√©es
                    </button>
                    <button class="btn btn-secondary" onclick="importData()" style="margin-left: 12px;">
                        <i class="fas fa-upload"></i>
                        Importer Donn√©es
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h3 class="card-title"><i class="fas fa-cloud" style="color: var(--primary); margin-right: 8px;"></i>Synchronisation Cloud</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 16px;">
                        Vos donn√©es sont synchronis√©es automatiquement. Utilisez l'ID ci-dessous pour connecter un autre appareil.
                    </p>
                    
                    <div id="cloudInfo"></div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <label style="margin-bottom: 8px;">Connecter un autre appareil</label>
                        <p style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 12px;">
                            Collez l'ID de synchronisation de votre autre appareil pour r√©cup√©rer vos donn√©es :
                        </p>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="binIdInput" placeholder="Collez l'ID ici..." style="flex: 1;">
                            <button class="btn" onclick="connectToBin()">
                                <i class="fas fa-link"></i> Connecter
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h3 class="card-title" style="color: var(--danger);">Zone Dangereuse</h3>
                    <button class="btn btn-danger" onclick="resetAll()">
                        <i class="fas fa-trash"></i>
                        R√©initialiser Tout
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: ADD BET -->
    <div class="modal" id="addBetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nouveau Pari</h2>
                <button class="close-modal" onclick="closeModal('addBetModal')">√ó</button>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="simple">Simple</div>
                <div class="tab" data-tab="combine">Combin√©</div>
                <div class="tab" data-tab="systeme">Syst√®me</div>
            </div>

            <!-- SIMPLE BET -->
            <div class="tab-content active" id="simple">
                <form id="simpleBetForm">
                    <div class="form-group">
                        <label>Nom du Pari *</label>
                        <input type="text" id="simpleName" required placeholder="PSG gagne">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Sport *</label>
                            <select id="simpleSport" required>
                                <option value="">S√©lectionner</option>
                                <option value="Football">Football</option>
                                <option value="Basketball">Basketball</option>
                                <option value="Tennis">Tennis</option>
                                <option value="Rugby">Rugby</option>
                                <option value="MMA">MMA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ligue</label>
                            <input type="text" id="simpleLeague" placeholder="Ligue 1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Match</label>
                        <input type="text" id="simpleMatch" placeholder="PSG vs OM">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Montant (‚Ç¨) *</label>
                            <input type="number" step="0.01" id="simpleAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Cote *</label>
                            <input type="number" step="0.01" id="simpleOdds" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Confiance <input type="number" id="simpleConfDisplay" min="0" max="100" value="50" style="width: 52px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--primary); font-weight: 700; font-size: 0.95em; text-align: center; display: inline; font-family: inherit;">%</label>
                        <input type="range" id="simpleConf" min="0" max="100" value="50">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Statut *</label>
                            <select id="simpleStatus" required>
                                <option value="en-cours">En cours</option>
                                <option value="gagne">Gagn√©</option>
                                <option value="perdu">Perdu</option>
                                <option value="cashout">Cashout</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Bookmaker</label>
                            <select id="simpleBookmaker">
                                <option value="">S√©lectionner</option>
                                <option value="Betclic">Betclic</option>
                                <option value="Unibet">Unibet</option>
                                <option value="Winamax">Winamax</option>
                                <option value="PMU">PMU</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">Ajouter</button>
                </form>
            </div>

            <!-- COMBINED BET -->
            <div class="tab-content" id="combine">
                <form id="combinedForm">
                    <div class="form-group">
                        <label>Nom *</label>
                        <input type="text" id="combinedName" required>
                    </div>

                    <div id="combinedMatches">
                        <div class="combined-match" data-idx="0">
                            <div class="combined-header">
                                <span class="combined-title">Match 1</span>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeMatch(0)">√ó</button>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Sport</label>
                                    <select class="combined-sport">
                                        <option value="Football">Football</option>
                                        <option value="Basketball">Basketball</option>
                                        <option value="Tennis">Tennis</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Match</label>
                                    <input type="text" class="combined-match">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Prono</label>
                                    <input type="text" class="combined-bet">
                                </div>
                                <div class="form-group">
                                    <label>Cote</label>
                                    <input type="number" step="0.01" class="combined-odds">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="addMatch()" style="width: 100%; margin-bottom: 16px;">
                        <i class="fas fa-plus"></i>
                        Ajouter Match
                    </button>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Mise (‚Ç¨) *</label>
                            <input type="number" step="0.01" id="combinedAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Cote Totale</label>
                            <input type="number" step="0.01" id="combinedTotal" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Confiance <input type="number" id="combinedConfDisplay" min="0" max="100" value="50" style="width: 52px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--primary); font-weight: 700; font-size: 0.95em; text-align: center; display: inline; font-family: inherit;">%</label>
                            <input type="range" id="combinedConf" min="0" max="100" value="50">
                        </div>
                        <div class="form-group">
                            <label>Statut</label>
                            <select id="combinedStatus">
                                <option value="en-cours">En cours</option>
                                <option value="gagne">Gagn√©</option>
                                <option value="perdu">Perdu</option>
                                <option value="cashout">Cashout</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Bookmaker</label>
                        <select id="combinedBookmaker">
                            <option value="">S√©lectionner</option>
                            <option value="Betclic">Betclic</option>
                            <option value="Unibet">Unibet</option>
                        </select>
                    </div>

                    <button type="submit" class="btn" style="width: 100%;">Ajouter</button>
                </form>
            </div>

            <!-- SYSTEM BET -->
            <div class="tab-content" id="systeme">
                <form id="systemForm">
                    <div class="form-group">
                        <label>Nom *</label>
                        <input type="text" id="systemName" required>
                    </div>

                    <div class="form-group">
                        <label>Type</label>
                        <select id="systemType">
                            <option value="2/3">2/3 (Trixie)</option>
                            <option value="2/4">2/4 (Yankee)</option>
                            <option value="3/4">3/4</option>
                            <option value="2/5">2/5</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Mise Unitaire (‚Ç¨) *</label>
                        <input type="number" step="0.01" id="systemStake" required>
                    </div>

                    <button type="submit" class="btn" style="width: 100%;">Cr√©er</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD BANKROLL -->
    <div class="modal" id="addBankrollModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Nouvelle Bankroll</h2>
                <button class="close-modal" onclick="closeModal('addBankrollModal')">√ó</button>
            </div>

            <form id="bankrollForm">
                <div class="form-group">
                    <label>Nom *</label>
                    <input type="text" id="bankrollName" required>
                </div>

                <div class="form-group">
                    <label>Montant Initial (‚Ç¨) *</label>
                    <input type="number" step="0.01" id="bankrollAmount" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="bankrollDesc"></textarea>
                </div>

                <button type="submit" class="btn" style="width: 100%;">Cr√©er</button>
            </form>
        </div>
    </div>

    <!-- MODAL: EDIT BANKROLL -->
    <div class="modal" id="editBankrollModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Modifier la Bankroll</h2>
                <button class="close-modal" onclick="closeModal('editBankrollModal')">√ó</button>
            </div>

            <form id="editBankrollForm">
                <input type="hidden" id="editBankrollId">
                
                <div class="form-group">
                    <label>Nom *</label>
                    <input type="text" id="editBankrollName" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editBankrollDesc"></textarea>
                </div>

                <div class="form-group">
                    <label style="margin-bottom: 12px;">R√©partition par Bookmaker</label>
                    <div id="bookmakersList"></div>
                </div>

                <button type="submit" class="btn" style="width: 100%;">Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- CUSTOM CONFIRM MODAL -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-box">
            <div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
            <h3 class="confirm-title" id="confirmTitle">Confirmer</h3>
            <p class="confirm-message" id="confirmMessage">√ätes-vous s√ªr ?</p>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-cancel" id="confirmCancel">Annuler</button>
                <button class="confirm-btn confirm-ok" id="confirmOk">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
// ===================================
// GLOBAL SPORT ICONS
// ===================================
const betSportIcons = {
    'Football': '‚öΩ',
    'Soccer': '‚öΩ',
    'Basketball': 'üèÄ',
    'Tennis': 'üéæ',
    'Rugby': 'üèâ',
    'MMA': 'ü•ä',
    'Fighting': 'ü•ä',
    'Hockey': 'üèí',
    'Ice Hockey': 'üèí',
    'Baseball': '‚öæ',
    'Handball': 'ü§æ',
    'Volleyball': 'üèê',
    'Motorsport': 'üèéÔ∏è',
    'American Football': 'üèà',
    'Cricket': 'üèè',
    'Golf': '‚õ≥',
    'Cyclisme': 'üö¥',
    'Boxe': 'ü•ä',
    'Natation': 'üèä',
    'Athl√©tisme': 'üèÉ',
    'Esport': 'üéÆ',
    'Formule 1': 'üèéÔ∏è',
};

function getSportIcon(sport) {
    if (!sport) return 'üèüÔ∏è';
    return betSportIcons[sport] || 'üèüÔ∏è';
}

// ===================================
// MOBILE MENU
// ===================================
function toggleMobileMenu() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const hamburger = document.getElementById('hamburgerBtn');
    
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
    hamburger.classList.toggle('active');
}

// Close mobile menu when clicking a nav item
document.addEventListener('click', (e) => {
    const navItem = e.target.closest('.nav-item');
    if (navItem && window.innerWidth <= 768) {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const hamburger = document.getElementById('hamburgerBtn');
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('active');
        hamburger.classList.remove('active');
    }
});

// ===================================
// CUSTOM CONFIRM DIALOG
// ===================================
function customConfirm(title, message, icon = '‚ö†Ô∏è', okText = 'Confirmer', dangerMode = false) {
    return new Promise((resolve) => {
        const overlay = document.getElementById('confirmOverlay');
        const titleEl = document.getElementById('confirmTitle');
        const msgEl = document.getElementById('confirmMessage');
        const iconEl = document.getElementById('confirmIcon');
        const okBtn = document.getElementById('confirmOk');
        const cancelBtn = document.getElementById('confirmCancel');

        titleEl.textContent = title;
        msgEl.textContent = message;
        iconEl.textContent = icon;
        okBtn.textContent = okText;

        if (dangerMode) {
            okBtn.style.background = 'linear-gradient(135deg, var(--danger), #dc2626)';
        } else {
            okBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-dark))';
        }

        overlay.classList.add('active');

        function cleanup() {
            overlay.classList.remove('active');
            okBtn.removeEventListener('click', onOk);
            cancelBtn.removeEventListener('click', onCancel);
            overlay.removeEventListener('click', onOverlay);
        }

        function onOk() { cleanup(); resolve(true); }
        function onCancel() { cleanup(); resolve(false); }
        function onOverlay(e) { if (e.target === overlay) { cleanup(); resolve(false); } }

        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
        overlay.addEventListener('click', onOverlay);
    });
}

// ===================================
// DATA & STATE + JSONBIN SYNC
// ===================================
const JSONBIN_API_KEY = '$2a$10$88c8JbIkwDurineaXh4r0eZbBFd1BcccRkGtfonBD9MQ8Qq41Sd8e';
let JSONBIN_BIN_ID = localStorage.getItem('jsonbin_bin_id') || null;
let isSyncing = false;
let syncQueue = false;

let bankrolls = JSON.parse(localStorage.getItem('bankrolls')) || [];
let currentBankrollId = localStorage.getItem('currentBankrollId') || null;
let charts = {};
let matchIndex = 1;
let editingBetId = null;

// Initialize
if (bankrolls.length === 0) {
    bankrolls.push({
        id: Date.now(),
        name: 'Bankroll Principale',
        initialAmount: 1000,
        currentAmount: 1000,
        bookmakers: {},
        bets: [],
        createdAt: new Date().toISOString()
    });
    currentBankrollId = bankrolls[0].id;
    saveData();
}

if (!currentBankrollId) currentBankrollId = bankrolls[0].id;

function getCurrentBankroll() {
    return bankrolls.find(b => b.id == currentBankrollId);
}

function saveData() {
    // Always save locally first (instant)
    localStorage.setItem('bankrolls', JSON.stringify(bankrolls));
    localStorage.setItem('currentBankrollId', currentBankrollId);
    localStorage.setItem('lastSyncDate', new Date().toISOString());
    // Sync to cloud
    syncToCloud();
}

// Show sync status
function showSyncStatus(status) {
    let indicator = document.getElementById('syncIndicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'syncIndicator';
        indicator.style.cssText = 'position:fixed;bottom:16px;right:16px;padding:8px 16px;border-radius:10px;font-size:0.8em;font-weight:600;z-index:9999;transition:all 0.3s;font-family:inherit;display:flex;align-items:center;gap:6px;';
        document.body.appendChild(indicator);
    }
    
    if (status === 'syncing') {
        indicator.style.background = 'var(--bg-card)';
        indicator.style.border = '1px solid var(--border)';
        indicator.style.color = 'var(--text-secondary)';
        indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Synchronisation...';
        indicator.style.opacity = '1';
    } else if (status === 'ok') {
        indicator.style.background = 'rgba(16,185,129,0.15)';
        indicator.style.border = '1px solid var(--success)';
        indicator.style.color = 'var(--success)';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> Synchronis√©';
        indicator.style.opacity = '1';
        setTimeout(() => { indicator.style.opacity = '0'; }, 2000);
    } else if (status === 'error') {
        indicator.style.background = 'rgba(239,68,68,0.15)';
        indicator.style.border = '1px solid var(--danger)';
        indicator.style.color = 'var(--danger)';
        indicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erreur sync';
        indicator.style.opacity = '1';
        setTimeout(() => { indicator.style.opacity = '0'; }, 3000);
    }
}

// Create a new bin
async function createBin() {
    try {
        const res = await fetch('https://api.jsonbin.io/v3/b', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Access-Key': JSONBIN_API_KEY,
                'X-Bin-Name': 'bet-tracker-data',
                'X-Bin-Private': 'false'
            },
            body: JSON.stringify({
                bankrolls: bankrolls,
                currentBankrollId: currentBankrollId,
                lastUpdated: new Date().toISOString()
            })
        });
        const data = await res.json();
        if (data.metadata && data.metadata.id) {
            JSONBIN_BIN_ID = data.metadata.id;
            localStorage.setItem('jsonbin_bin_id', JSONBIN_BIN_ID);
            return true;
        }
    } catch(e) { console.error('Create bin error:', e); }
    return false;
}

// Sync to cloud (debounced)
let syncTimeout = null;
function syncToCloud() {
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(() => _doSync(), 1500);
}

async function _doSync() {
    if (isSyncing) { syncQueue = true; return; }
    isSyncing = true;
    showSyncStatus('syncing');

    try {
        if (!JSONBIN_BIN_ID) {
            await createBin();
        }
        
        if (JSONBIN_BIN_ID) {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': JSONBIN_API_KEY
                },
                body: JSON.stringify({
                    bankrolls: bankrolls,
                    currentBankrollId: currentBankrollId,
                    lastUpdated: new Date().toISOString()
                })
            });
            
            if (res.ok) {
                showSyncStatus('ok');
            } else {
                showSyncStatus('error');
            }
        }
    } catch(e) {
        console.error('Sync error:', e);
        showSyncStatus('error');
    } finally {
        isSyncing = false;
        if (syncQueue) {
            syncQueue = false;
            syncToCloud();
        }
    }
}

// Load from cloud on startup
async function loadFromCloud() {
    if (!JSONBIN_BIN_ID) return false;
    
    showSyncStatus('syncing');
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            headers: { 'X-Access-Key': JSONBIN_API_KEY }
        });
        
        if (res.ok) {
            const data = await res.json();
            const record = data.record;
            
            if (record && record.bankrolls && record.bankrolls.length > 0) {
                // Check which is newer: local or cloud
                const cloudDate = new Date(record.lastUpdated || 0);
                const localDate = new Date(localStorage.getItem('lastSyncDate') || 0);
                
                if (cloudDate >= localDate || bankrolls.length <= 1 && bankrolls[0]?.bets?.length === 0) {
                    bankrolls = record.bankrolls;
                    currentBankrollId = record.currentBankrollId || bankrolls[0].id;
                    localStorage.setItem('bankrolls', JSON.stringify(bankrolls));
                    localStorage.setItem('currentBankrollId', currentBankrollId);
                    showSyncStatus('ok');
                    return true;
                }
            }
            showSyncStatus('ok');
        } else {
            showSyncStatus('error');
        }
    } catch(e) {
        console.error('Load from cloud error:', e);
        showSyncStatus('error');
    }
    return false;
}

// Manual sync button for settings
function forceSyncNow() {
    _doSync();
}

// Show bin ID in settings for cross-device setup
function showCloudInfo() {
    const el = document.getElementById('cloudInfo');
    if (!el) return;
    if (JSONBIN_BIN_ID) {
        el.innerHTML = `
            <div style="padding:16px;background:var(--bg-secondary);border-radius:12px;margin-top:12px;">
                <div style="font-size:0.85em;color:var(--text-secondary);margin-bottom:8px;">ID de synchronisation (√† noter pour connecter un autre appareil) :</div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <code style="flex:1;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-size:0.85em;word-break:break-all;color:var(--primary);font-weight:600;">${JSONBIN_BIN_ID}</code>
                    <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${JSONBIN_BIN_ID}');this.innerHTML='<i class=\\'fas fa-check\\'></i> Copi√©'"><i class="fas fa-copy"></i></button>
                </div>
                <div style="margin-top:12px;">
                    <button class="btn btn-sm" onclick="forceSyncNow()"><i class="fas fa-sync-alt"></i> Forcer la synchronisation</button>
                </div>
            </div>
        `;
    } else {
        el.innerHTML = `<div style="padding:12px;color:var(--text-secondary);font-size:0.9em;">Synchronisation en cours de configuration...</div>`;
    }
}

// Connect to existing bin (from another device)
function connectToBin() {
    const id = document.getElementById('binIdInput').value.trim();
    if (id) {
        JSONBIN_BIN_ID = id;
        localStorage.setItem('jsonbin_bin_id', id);
        loadFromCloud().then(loaded => {
            if (loaded) {
                updateDashboard();
                showCloudInfo();
            }
        });
    }
}

// ===================================
// NAVIGATION
// ===================================
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        const page = item.dataset.page;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(page).classList.add('active');

        if (page === 'dashboard') updateDashboard();
        if (page === 'bets') updateBetsPage();
        if (page === 'analyzer') updateAnalyzer();
        if (page === 'optimizer') updateOptimizer();
        if (page === 'pronostics') updatePronostics();
        if (page === 'bankrolls') updateBankrollsPage();
    });
});

// ===================================
// THEME
// ===================================
const themeToggle = document.getElementById('themeToggle');
const darkModeSwitch = document.getElementById('darkModeSwitch');
const savedTheme = localStorage.getItem('theme') || 'light';

document.body.setAttribute('data-theme', savedTheme);
themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
darkModeSwitch.checked = savedTheme === 'dark';

function toggleTheme() {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    darkModeSwitch.checked = newTheme === 'dark';
    updateDashboard();
    updateAnalyzer();
}

themeToggle.addEventListener('click', toggleTheme);
darkModeSwitch.addEventListener('change', toggleTheme);

// ===================================
// MODALS
// ===================================
function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
    if (id === 'addBetModal') {
        document.querySelector('#addBetModal .modal-title').textContent = 'Nouveau Pari';
        const submitBtn = document.querySelector('#simpleBetForm button[type="submit"]');
        if (submitBtn) submitBtn.textContent = 'Ajouter';
    }
    editingBetId = null;
}

document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    });
});

// ===================================
// TABS
// ===================================
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const parent = tab.parentElement;
        const tabName = tab.dataset.tab;
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        parent.parentElement.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
    });
});

// ===================================
// BANKROLL MANAGEMENT
// ===================================
function renderBankrollSelector(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = bankrolls.map(br => `
        <div class="bankroll-item ${br.id == currentBankrollId ? 'active' : ''}" 
             onclick="switchBankroll(${br.id})">
            ${br.name}
        </div>
    `).join('') + `
        <div class="bankroll-item" onclick="openModal('addBankrollModal')" style="opacity: 0.6;">
            <i class="fas fa-plus"></i> Nouvelle
        </div>
    `;
}

function switchBankroll(id) {
    currentBankrollId = id;
    saveData();
    updateApp();
}

document.getElementById('bankrollForm').addEventListener('submit', (e) => {
    e.preventDefault();
    bankrolls.push({
        id: Date.now(),
        name: document.getElementById('bankrollName').value,
        initialAmount: parseFloat(document.getElementById('bankrollAmount').value),
        currentAmount: parseFloat(document.getElementById('bankrollAmount').value),
        description: document.getElementById('bankrollDesc').value,
        bookmakers: {},
        bets: [],
        createdAt: new Date().toISOString()
    });
    saveData();
    closeModal('addBankrollModal');
    e.target.reset();
    updateApp();
});

function updateBankrollsPage() {
    const container = document.getElementById('bankrollsList');
    container.innerHTML = bankrolls.map(br => {
        const stats = calculateStats(br);
        
        // Bookmakers breakdown
        const bookmakersHtml = Object.keys(br.bookmakers).length > 0 ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="font-size: 0.85em; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">R√©partition Bookmakers</div>
                ${Object.entries(br.bookmakers).map(([bm, data]) => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9em;">
                        <span>${bm}</span>
                        <span style="font-weight: 600;">${data.current.toFixed(2)} ‚Ç¨</span>
                    </div>
                `).join('')}
            </div>
        ` : '';
        
        return `
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                    <h3 style="margin: 0;">${br.name}</h3>
                    <div>
                        <button class="btn btn-sm btn-secondary" onclick="editBankroll(${br.id})" style="margin-right: 8px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBankroll(${br.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 20px;">
                    ${br.description || 'Aucune description'}
                </p>
                <div style="margin-bottom: 12px;">
                    <div style="color: var(--text-secondary); font-size: 0.85em;">Bankroll Totale</div>
                    <div style="font-size: 2em; font-weight: 800; color: var(--primary);">
                        ${stats.currentAmount.toFixed(2)} ‚Ç¨
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Profit</div>
                        <div style="font-weight: 700; color: ${stats.profit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${stats.profit >= 0 ? '+' : ''}${stats.profit.toFixed(2)} ‚Ç¨
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">ROI</div>
                        <div style="font-weight: 700; color: ${stats.roi >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${stats.roi >= 0 ? '+' : ''}${stats.roi.toFixed(2)}%
                        </div>
                    </div>
                </div>
                ${bookmakersHtml}
                <button class="btn btn-sm" style="margin-top: 16px; width: 100%;" onclick="switchBankroll(${br.id}); document.querySelector('[data-page=dashboard]').click();">
                    <i class="fas fa-chart-line"></i> Voir Dashboard
                </button>
            </div>
        `;
    }).join('');
}

function editBankroll(id) {
    openModal('editBankrollModal');
    const br = bankrolls.find(b => b.id === id);
    
    document.getElementById('editBankrollId').value = id;
    document.getElementById('editBankrollName').value = br.name;
    document.getElementById('editBankrollDesc').value = br.description || '';
    
    // Render bookmakers
    renderBookmakersList(br);
}

function renderBookmakersList(br) {
    const container = document.getElementById('bookmakersList');
    const total = Object.values(br.bookmakers).reduce((sum, bm) => sum + bm.current, 0);
    
    container.innerHTML = `
        <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <span style="font-weight: 600;">Total R√©parti:</span>
                <span style="font-weight: 700; color: var(--primary);">${total.toFixed(2)} ‚Ç¨ / ${br.currentAmount.toFixed(2)} ‚Ç¨</span>
            </div>
            ${total !== br.currentAmount ? `
                <div style="color: var(--warning); font-size: 0.85em; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                    <i class="fas fa-exclamation-triangle"></i> Diff√©rence de ${Math.abs(br.currentAmount - total).toFixed(2)} ‚Ç¨
                </div>
            ` : ''}
        </div>
        
        <div id="bookmakersInputs">
            ${Object.entries(br.bookmakers).map(([name, data], idx) => `
                <div class="form-row" style="align-items: end; margin-bottom: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Bookmaker</label>
                        <input type="text" class="bm-name" value="${name}" data-idx="${idx}">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Montant (‚Ç¨)</label>
                        <input type="number" step="0.01" class="bm-amount" value="${data.current}" data-idx="${idx}">
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeBookmaker(${idx})" style="height: 46px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('')}
        </div>
        
        <button type="button" class="btn btn-secondary" onclick="addBookmaker()" style="width: 100%; margin-top: 8px;">
            <i class="fas fa-plus"></i> Ajouter Bookmaker
        </button>
    `;
}

let bookmakerIndex = 0;

function addBookmaker() {
    const container = document.getElementById('bookmakersInputs');
    container.insertAdjacentHTML('beforeend', `
        <div class="form-row" style="align-items: end; margin-bottom: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label>Bookmaker</label>
                <input type="text" class="bm-name" data-idx="new-${bookmakerIndex}" placeholder="Winamax">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Montant (‚Ç¨)</label>
                <input type="number" step="0.01" class="bm-amount" data-idx="new-${bookmakerIndex}" placeholder="100">
            </div>
            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()" style="height: 46px;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `);
    bookmakerIndex++;
}

function removeBookmaker(idx) {
    document.querySelector(`[data-idx="${idx}"]`).parentElement.parentElement.remove();
}

document.getElementById('editBankrollForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const id = parseInt(document.getElementById('editBankrollId').value);
    const br = bankrolls.find(b => b.id === id);
    
    br.name = document.getElementById('editBankrollName').value;
    br.description = document.getElementById('editBankrollDesc').value;
    
    // Update bookmakers
    const newBookmakers = {};
    document.querySelectorAll('.bm-name').forEach((input, idx) => {
        const name = input.value.trim();
        const amount = parseFloat(document.querySelectorAll('.bm-amount')[idx].value) || 0;
        
        if (name && amount > 0) {
            // Keep initial amount if bookmaker already exists
            const initial = br.bookmakers[name]?.initial || amount;
            newBookmakers[name] = {
                initial: initial,
                current: amount
            };
        }
    });
    
    br.bookmakers = newBookmakers;
    
    saveData();
    closeModal('editBankrollModal');
    updateApp();
});

async function deleteBankroll(id) {
    if (bankrolls.length === 1) {
        await customConfirm('Impossible', 'Vous ne pouvez pas supprimer la derni√®re bankroll.', '‚ùå', 'OK', false);
        return;
    }
    const confirmed = await customConfirm(
        'Supprimer cette bankroll ?',
        'Tous les paris associ√©s seront √©galement supprim√©s.',
        'üóëÔ∏è',
        'Supprimer',
        true
    );
    if (confirmed) {
        bankrolls = bankrolls.filter(b => b.id !== id);
        if (currentBankrollId == id) currentBankrollId = bankrolls[0].id;
        saveData();
        updateApp();
    }
}

// ===================================
// BET FORMS
// ===================================

// Simple
document.getElementById('simpleConf').addEventListener('input', (e) => {
    document.getElementById('simpleConfDisplay').value = e.target.value;
});
document.getElementById('simpleConfDisplay').addEventListener('input', (e) => {
    let val = Math.min(100, Math.max(0, parseInt(e.target.value) || 0));
    document.getElementById('simpleConf').value = val;
});

// Smart sport detection from bet name
const SPORT_PATTERNS = {
    'Tennis': [
        /jeux/i, /sets?/i, /ace/i, /tie[\s-]?break/i, /double faute/i,
        /service/i, /atp/i, /wta/i, /roland[\s-]?garros/i, /wimbledon/i,
        /us[\s-]?open/i, /open[\s-]?australi/i, /nadal/i, /djokovic/i,
        /federer/i, /sinner/i, /alcaraz/i, /swiatek/i, /sabalenka/i,
        /\+\d+\.?\d*\s*jeux/i, /\-\d+\.?\d*\s*jeux/i,
        /\d+[.,]\d+\s*jeux/i
    ],
    'Basketball': [
        /points?/i, /mi[\s-]?temps/i, /nba/i, /euroleague/i, /ncaa/i,
        /rebond/i, /assist/i, /panier/i, /lancer/i, /dunk/i,
        /quarter/i, /quart[\s-]?temps/i, /overtime/i, /prolongation/i,
        /lakers/i, /celtics/i, /warriors/i, /bucks/i,
        /\+\d+\.?\d*\s*points?/i, /\-\d+\.?\d*\s*points?/i,
        /\d+[.,]\d+\s*points?/i, /handicap.*\d+/i
    ],
    'Football': [
        /but(s|eur)?/i, /corner/i, /carton/i, /clean[\s-]?sheet/i,
        /mi[\s-]?temps.*\d.*\d/i, /score[\s-]?exact/i,
        /ligue[\s-]?\d/i, /premier[\s-]?league/i, /liga/i, /serie[\s-]?a/i,
        /bundesliga/i, /champions[\s-]?league/i, /europa/i,
        /hors[\s-]?jeu/i, /penalty/i, /tir.*cadr√©/i,
        /psg/i, /real[\s-]?madrid/i, /barcelona/i, /bayern/i,
        /victoire.*domicile/i, /victoire.*ext√©rieur/i,
        /btts/i, /les[\s-]?deux.*marqu/i, /1n2/i,
        /\+\d+\.?\d*\s*buts?/i, /\-\d+\.?\d*\s*buts?/i
    ],
    'Rugby': [
        /essai/i, /transformation/i, /m√™l√©e/i, /touche/i,
        /top[\s-]?14/i, /pro[\s-]?d2/i, /six[\s-]?nations/i,
        /rugby/i, /drop/i, /p√©nalit√©.*rugby/i
    ],
    'MMA': [
        /round/i, /ko/i, /soumission/i, /d√©cision/i, /ufc/i,
        /bellator/i, /octogone/i, /tko/i, /combat/i,
        /poids.*lourd/i, /poids.*l√©ger/i, /poids.*moyen/i
    ]
};

function detectSport(text) {
    let bestMatch = '';
    let bestScore = 0;
    
    for (const [sport, patterns] of Object.entries(SPORT_PATTERNS)) {
        let score = 0;
        for (const pattern of patterns) {
            if (pattern.test(text)) score++;
        }
        if (score > bestScore) {
            bestScore = score;
            bestMatch = sport;
        }
    }
    
    return bestScore > 0 ? bestMatch : '';
}

// Auto-detect sport when typing bet name
document.getElementById('simpleName').addEventListener('input', (e) => {
    const text = e.target.value;
    const sportSelect = document.getElementById('simpleSport');
    
    // Only auto-detect if no sport is manually selected yet
    if (!sportSelect.dataset.manuallySet) {
        const detected = detectSport(text);
        if (detected) {
            sportSelect.value = detected;
            sportSelect.style.borderColor = 'var(--success)';
            setTimeout(() => { sportSelect.style.borderColor = ''; }, 1500);
        }
    }
});

// Also detect from match field
document.getElementById('simpleMatch').addEventListener('input', (e) => {
    const text = e.target.value + ' ' + document.getElementById('simpleName').value;
    const sportSelect = document.getElementById('simpleSport');
    
    if (!sportSelect.dataset.manuallySet) {
        const detected = detectSport(text);
        if (detected) {
            sportSelect.value = detected;
            sportSelect.style.borderColor = 'var(--success)';
            setTimeout(() => { sportSelect.style.borderColor = ''; }, 1500);
        }
    }
});

// Mark as manually set when user changes sport dropdown directly
document.getElementById('simpleSport').addEventListener('change', (e) => {
    if (e.isTrusted) {
        e.target.dataset.manuallySet = 'true';
    }
});

// Reset manual flag when modal opens for new bet
const originalOpenModal = openModal;
openModal = function(id) {
    originalOpenModal(id);
    if (id === 'addBetModal' && !editingBetId) {
        document.getElementById('simpleSport').dataset.manuallySet = '';
    }
};

// Update bookmaker select based on available bookmakers
function updateBookmakerSelect(selectId) {
    const br = getCurrentBankroll();
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">S√©lectionner</option>';
    
    // Add bookmakers from bankroll
    Object.keys(br.bookmakers).forEach(bm => {
        select.innerHTML += `<option value="${bm}">${bm}</option>`;
    });
    
    // Add common bookmakers
    const common = ['Betclic', 'Unibet', 'Winamax', 'PMU', 'Parions Sport'];
    common.forEach(bm => {
        if (!br.bookmakers[bm]) {
            select.innerHTML += `<option value="${bm}">${bm}</option>`;
        }
    });
    
    // Restore value if it exists
    if (currentValue) select.value = currentValue;
}

// Check if bookmaker has enough funds
async function checkBookmakerFunds(bookmaker, amount) {
    if (!bookmaker) return true;
    
    const br = getCurrentBankroll();
    const bmData = br.bookmakers[bookmaker];
    
    if (!bmData) {
        return await customConfirm(
            'Bookmaker inconnu',
            `${bookmaker} n'est pas dans votre bankroll. Voulez-vous quand m√™me placer ce pari ?`,
            '‚ùì',
            'Placer quand m√™me',
            false
        );
    }
    
    if (bmData.current < amount) {
        await customConfirm(
            'Fonds insuffisants',
            `Fonds insuffisants sur ${bookmaker} !\nDisponible : ${bmData.current.toFixed(2)} ‚Ç¨\nDemand√© : ${amount.toFixed(2)} ‚Ç¨`,
            '‚ùå',
            'Compris',
            false
        );
        return false;
    }
    
    return true;
}

// Update bookmaker balance
function updateBookmakerBalance(br, bookmaker, amount, isWin, odds) {
    if (!bookmaker || bookmaker === '-') return;
    
    if (!br.bookmakers[bookmaker]) {
        br.bookmakers[bookmaker] = {
            initial: 0,
            current: 0
        };
    }
    
    if (isWin) {
        br.bookmakers[bookmaker].current += (amount * odds) - amount;
    } else {
        br.bookmakers[bookmaker].current -= amount;
    }
}

document.getElementById('simpleBetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const br = getCurrentBankroll();
    const amount = parseFloat(document.getElementById('simpleAmount').value);
    const bookmaker = document.getElementById('simpleBookmaker').value;
    
    // Check funds
    if (!(await checkBookmakerFunds(bookmaker, amount))) return;
    
    const bet = {
        id: editingBetId || Date.now(),
        type: 'simple',
        name: document.getElementById('simpleName').value,
        sport: document.getElementById('simpleSport').value,
        league: document.getElementById('simpleLeague').value || '-',
        match: document.getElementById('simpleMatch').value || '-',
        amount: amount,
        odds: parseFloat(document.getElementById('simpleOdds').value),
        confidence: parseInt(document.getElementById('simpleConf').value),
        status: document.getElementById('simpleStatus').value,
        bookmaker: bookmaker || '-',
        date: editingBetId ? br.bets.find(b => String(b.id) === String(editingBetId)).date : new Date().toISOString()
    };

    // If cashout, ask for the amount
    if (bet.status === 'cashout') {
        const cashoutVal = await showCashoutInput(amount);
        if (cashoutVal === null) return;
        bet.cashoutAmount = cashoutVal;
    }
    
    if (editingBetId) {
        // Remove old bet and recalculate
        const oldBet = br.bets.find(b => String(b.id) === String(editingBetId));
        br.bets = br.bets.filter(b => String(b.id) !== String(editingBetId));
        
        // Reverse old bet impact on bookmaker
        if (oldBet.status === 'gagne') {
            updateBookmakerBalance(br, oldBet.bookmaker, -oldBet.amount, true, oldBet.odds);
        } else if (oldBet.status === 'perdu') {
            updateBookmakerBalance(br, oldBet.bookmaker, -oldBet.amount, false, 0);
        }
    }
    
    br.bets.push(bet);
    
    // Update bookmaker balance
    if (bet.status === 'gagne') {
        updateBookmakerBalance(br, bookmaker, amount, true, bet.odds);
    } else if (bet.status === 'perdu') {
        updateBookmakerBalance(br, bookmaker, amount, false, 0);
    }
    
    updateBankrollAmount(br);
    saveData();
    closeModal('addBetModal');
    e.target.reset();
    document.getElementById('simpleConfDisplay').value = 50;
    document.querySelector('#addBetModal .modal-title').textContent = 'Nouveau Pari';
    const submitBtn = document.querySelector('#simpleBetForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Ajouter';
    editingBetId = null;
    updateApp();
});

// Edit bet
function editBet(id) {
    const br = getCurrentBankroll();
    const bet = br.bets.find(b => String(b.id) === String(id));
    
    if (!bet) return;
    
    if (bet.type !== 'simple') {
        customConfirm('Non disponible', '√âdition disponible uniquement pour les paris simples pour le moment.', '‚ÑπÔ∏è', 'OK', false);
        return;
    }
    
    editingBetId = bet.id;
    
    // Change modal title
    document.querySelector('#addBetModal .modal-title').textContent = 'Modifier le Pari';
    
    // Open modal first
    openModal('addBetModal');
    
    // Switch to simple tab
    const simpleTab = document.querySelector('[data-tab="simple"]');
    if (simpleTab) simpleTab.click();
    
    // Fill form
    document.getElementById('simpleName').value = bet.name;
    document.getElementById('simpleSport').value = bet.sport;
    document.getElementById('simpleLeague').value = bet.league === '-' ? '' : bet.league;
    document.getElementById('simpleMatch').value = bet.match === '-' ? '' : bet.match;
    document.getElementById('simpleAmount').value = bet.amount;
    document.getElementById('simpleOdds').value = bet.odds;
    document.getElementById('simpleConf').value = bet.confidence;
    document.getElementById('simpleConfDisplay').value = bet.confidence;
    document.getElementById('simpleStatus').value = bet.status;
    updateBookmakerSelect('simpleBookmaker');
    document.getElementById('simpleBookmaker').value = bet.bookmaker === '-' ? '' : bet.bookmaker;
    
    // Change button text
    const submitBtn = document.querySelector('#simpleBetForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Modifier';
}

// Reset modal on close
document.querySelector('#addBetModal .close-modal').addEventListener('click', () => {
    document.querySelector('#addBetModal .modal-title').textContent = 'Nouveau Pari';
    const submitBtn = document.querySelector('#simpleBetForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Ajouter';
    editingBetId = null;
});

// Combined
function addMatch() {
    const container = document.getElementById('combinedMatches');
    container.insertAdjacentHTML('beforeend', `
        <div class="combined-match" data-idx="${matchIndex}">
            <div class="combined-header">
                <span class="combined-title">Match ${matchIndex + 1}</span>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeMatch(${matchIndex})">√ó</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Sport</label>
                    <select class="combined-sport">
                        <option value="Football">Football</option>
                        <option value="Basketball">Basketball</option>
                        <option value="Tennis">Tennis</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Match</label>
                    <input type="text" class="combined-match">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Prono</label>
                    <input type="text" class="combined-bet">
                </div>
                <div class="form-group">
                    <label>Cote</label>
                    <input type="number" step="0.01" class="combined-odds">
                </div>
            </div>
        </div>
    `);
    matchIndex++;
    updateCombinedOdds();
}

function removeMatch(idx) {
    const match = document.querySelector(`[data-idx="${idx}"]`);
    if (document.querySelectorAll('.combined-match').length > 1) {
        match.remove();
        updateCombinedOdds();
    }
}

function updateCombinedOdds() {
    let total = 1;
    document.querySelectorAll('.combined-odds').forEach(input => {
        total *= parseFloat(input.value) || 1;
    });
    document.getElementById('combinedTotal').value = total.toFixed(2);
}

document.getElementById('combinedMatches').addEventListener('input', (e) => {
    if (e.target.classList.contains('combined-odds')) updateCombinedOdds();
});

document.getElementById('combinedConf').addEventListener('input', (e) => {
    document.getElementById('combinedConfDisplay').value = e.target.value;
});
document.getElementById('combinedConfDisplay').addEventListener('input', (e) => {
    let val = Math.min(100, Math.max(0, parseInt(e.target.value) || 0));
    document.getElementById('combinedConf').value = val;
});

document.getElementById('combinedForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const br = getCurrentBankroll();
    const amount = parseFloat(document.getElementById('combinedAmount').value);
    const bookmaker = document.getElementById('combinedBookmaker').value;
    
    // Check funds
    if (!(await checkBookmakerFunds(bookmaker, amount))) return;
    
    const matches = [];
    document.querySelectorAll('.combined-match').forEach(m => {
        matches.push({
            sport: m.querySelector('.combined-sport').value,
            match: m.querySelector('.combined-match').value,
            bet: m.querySelector('.combined-bet').value,
            odds: parseFloat(m.querySelector('.combined-odds').value)
        });
    });

    const bet = {
        id: Date.now(),
        type: 'combine',
        name: document.getElementById('combinedName').value,
        matches: matches,
        amount: amount,
        totalOdds: parseFloat(document.getElementById('combinedTotal').value),
        confidence: parseInt(document.getElementById('combinedConf').value),
        status: document.getElementById('combinedStatus').value,
        bookmaker: bookmaker || '-',
        date: new Date().toISOString()
    };
    
    br.bets.push(bet);
    
    // Update bookmaker balance
    if (bet.status === 'gagne') {
        updateBookmakerBalance(br, bookmaker, amount, true, bet.totalOdds);
    } else if (bet.status === 'perdu') {
        updateBookmakerBalance(br, bookmaker, amount, false, 0);
    }
    
    updateBankrollAmount(br);
    saveData();
    closeModal('addBetModal');
    e.target.reset();
    updateApp();
});

// System
document.getElementById('systemForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const br = getCurrentBankroll();
    const type = document.getElementById('systemType').value;
    const unitStake = parseFloat(document.getElementById('systemStake').value);
    const numBets = { '2/3': 3, '2/4': 6, '3/4': 4, '2/5': 10 }[type];

    br.bets.push({
        id: Date.now(),
        type: 'systeme',
        name: document.getElementById('systemName').value,
        systemType: type,
        unitStake: unitStake,
        amount: unitStake * numBets,
        numBets: numBets,
        status: 'en-cours',
        date: new Date().toISOString()
    });
    updateBankrollAmount(br);
    saveData();
    closeModal('addBetModal');
    e.target.reset();
    updateApp();
});

// Update bookmaker selects when modal opens
document.getElementById('addBetModal').addEventListener('click', (e) => {
    if (e.target.classList.contains('modal') && !editingBetId) {
        updateBookmakerSelect('simpleBookmaker');
        updateBookmakerSelect('combinedBookmaker');
    }
});

// ===================================
// CALCULATIONS
// ===================================
function calculateStats(bankroll) {
    const bets = bankroll.bets;
    const totalStake = bets.reduce((sum, b) => {
        if (b.status === 'gagne' || b.status === 'perdu' || b.status === 'cashout') return sum + b.amount;
        return sum;
    }, 0);

    const totalReturn = bets.reduce((sum, b) => {
        if (b.status === 'gagne') {
            const odds = b.type === 'combine' ? b.totalOdds : b.odds;
            return sum + (b.amount * odds);
        }
        if (b.status === 'cashout') {
            return sum + (b.cashoutAmount || 0);
        }
        return sum;
    }, 0);

    const profit = totalReturn - totalStake;
    const roi = totalStake > 0 ? ((profit / totalStake) * 100) : 0;

    const won = bets.filter(b => b.status === 'gagne').length;
    const lost = bets.filter(b => b.status === 'perdu').length;
    const cashout = bets.filter(b => b.status === 'cashout').length;
    const total = won + lost + cashout;
    const winRate = total > 0 ? ((won / total) * 100) : 0;

    return {
        currentAmount: bankroll.initialAmount + profit,
        profit,
        roi,
        winRate,
        wonBets: won,
        lostBets: lost,
        cashoutBets: cashout,
        totalBets: bets.length,
        inProgress: bets.filter(b => b.status === 'en-cours').length
    };
}

function updateBankrollAmount(bankroll) {
    bankroll.currentAmount = calculateStats(bankroll).currentAmount;
}

// ===================================
// STATUS HELPERS
// ===================================
const STATUS_CONFIG = {
    'en-cours': { label: 'En cours', badge: 'warning', color: 'var(--warning)', dot: '#f59e0b' },
    'gagne': { label: 'Gagn√©', badge: 'success', color: 'var(--success)', dot: '#10b981' },
    'perdu': { label: 'Perdu', badge: 'danger', color: 'var(--danger)', dot: '#ef4444' },
    'cashout': { label: 'Cashout', badge: 'cashout', color: 'var(--info)', dot: '#3b82f6' }
};

function renderStatusBadge(bet) {
    const cfg = STATUS_CONFIG[bet.status] || STATUS_CONFIG['en-cours'];
    const options = Object.entries(STATUS_CONFIG)
        .filter(([key]) => key !== bet.status)
        .map(([key, val]) => `<div class="status-option" onclick="event.stopPropagation(); changeBetStatus('${bet.id}', '${key}')"><span class="dot" style="background: ${val.dot}"></span>${val.label}</div>`)
        .join('');
    
    return `<div class="status-wrapper">
        <span class="badge ${cfg.badge} status-badge" onclick="event.stopPropagation(); toggleStatusDropdown(this)">${cfg.label}</span>
        <div class="status-dropdown">${options}</div>
    </div>`;
}

function toggleStatusDropdown(el) {
    // Close all other open dropdowns
    document.querySelectorAll('.status-dropdown.open').forEach(d => {
        if (d !== el.nextElementSibling) d.classList.remove('open');
    });
    el.nextElementSibling.classList.toggle('open');
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.status-wrapper')) {
        document.querySelectorAll('.status-dropdown.open').forEach(d => d.classList.remove('open'));
    }
});

async function changeBetStatus(id, newStatus) {
    const br = getCurrentBankroll();
    const bet = br.bets.find(b => String(b.id) === String(id));
    if (!bet) return;

    // Close dropdown
    document.querySelectorAll('.status-dropdown.open').forEach(d => d.classList.remove('open'));

    // If cashout, ask for the amount
    if (newStatus === 'cashout') {
        const cashoutModal = await showCashoutInput(bet.amount);
        if (cashoutModal === null) return;
        bet.cashoutAmount = cashoutModal;
    }

    // Reverse old bookmaker impact
    if (bet.bookmaker && bet.bookmaker !== '-' && br.bookmakers[bet.bookmaker]) {
        if (bet.status === 'gagne') {
            const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
            br.bookmakers[bet.bookmaker].current -= (bet.amount * odds) - bet.amount;
        } else if (bet.status === 'perdu') {
            br.bookmakers[bet.bookmaker].current += bet.amount;
        } else if (bet.status === 'cashout') {
            br.bookmakers[bet.bookmaker].current -= (bet.cashoutAmount || 0) - bet.amount;
        }
    }

    bet.status = newStatus;

    // Apply new bookmaker impact
    if (bet.bookmaker && bet.bookmaker !== '-' && br.bookmakers[bet.bookmaker]) {
        if (newStatus === 'gagne') {
            const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
            br.bookmakers[bet.bookmaker].current += (bet.amount * odds) - bet.amount;
        } else if (newStatus === 'perdu') {
            br.bookmakers[bet.bookmaker].current -= bet.amount;
        } else if (newStatus === 'cashout') {
            br.bookmakers[bet.bookmaker].current += (bet.cashoutAmount || 0) - bet.amount;
        }
    }

    updateBankrollAmount(br);
    saveData();
    updateApp();
}

function showCashoutInput(originalAmount) {
    return new Promise((resolve) => {
        const overlay = document.getElementById('confirmOverlay');
        const titleEl = document.getElementById('confirmTitle');
        const msgEl = document.getElementById('confirmMessage');
        const iconEl = document.getElementById('confirmIcon');
        const okBtn = document.getElementById('confirmOk');
        const cancelBtn = document.getElementById('confirmCancel');

        iconEl.textContent = 'üí∞';
        titleEl.textContent = 'Montant du Cashout';
        msgEl.innerHTML = `Mise initiale : <strong>${originalAmount.toFixed(2)} ‚Ç¨</strong><br><br>
            <input type="number" step="0.01" id="cashoutInput" placeholder="Montant r√©cup√©r√©" 
                   style="width: 100%; padding: 12px 16px; background: var(--bg); border: 2px solid var(--border); 
                   border-radius: 10px; color: var(--text); font-size: 1em; font-family: inherit; text-align: center;">`;
        okBtn.textContent = 'Valider';
        okBtn.style.background = 'linear-gradient(135deg, var(--info), #2563eb)';

        overlay.classList.add('active');
        setTimeout(() => { const inp = document.getElementById('cashoutInput'); if (inp) inp.focus(); }, 100);

        function cleanup() {
            overlay.classList.remove('active');
            okBtn.removeEventListener('click', onOk);
            cancelBtn.removeEventListener('click', onCancel);
        }

        function onOk() {
            const val = parseFloat(document.getElementById('cashoutInput')?.value);
            cleanup();
            if (isNaN(val) || val < 0) resolve(null);
            else resolve(val);
        }
        function onCancel() { cleanup(); resolve(null); }

        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
    });
}

function getResultText(bet) {
    const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
    if (bet.status === 'gagne' && odds) return '+' + ((bet.amount * odds) - bet.amount).toFixed(2) + ' ‚Ç¨';
    if (bet.status === 'perdu') return '-' + bet.amount.toFixed(2) + ' ‚Ç¨';
    if (bet.status === 'cashout') {
        const diff = (bet.cashoutAmount || 0) - bet.amount;
        return (diff >= 0 ? '+' : '') + diff.toFixed(2) + ' ‚Ç¨';
    }
    return '-';
}

function getResultColor(bet) {
    if (bet.status === 'gagne') return 'var(--success)';
    if (bet.status === 'perdu') return 'var(--danger)';
    if (bet.status === 'cashout') {
        return (bet.cashoutAmount || 0) >= bet.amount ? 'var(--info)' : 'var(--danger)';
    }
    return 'var(--text-secondary)';
}

// ===================================
// DASHBOARD
// ===================================
function updateDashboard() {
    renderBankrollSelector('bankrollSelector');
    const br = getCurrentBankroll();
    const stats = calculateStats(br);

    // Stats Grid
    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
            <div class="stat-label">Bankroll Actuelle</div>
            <div class="stat-value">${stats.currentAmount.toFixed(2)} ‚Ç¨</div>
            <div class="stat-change ${stats.profit >= 0 ? 'positive' : 'negative'}">
                <i class="fas fa-${stats.profit >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                ${Math.abs(stats.profit).toFixed(2)} ‚Ç¨
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ROI</div>
            <div class="stat-value" style="color: ${stats.roi >= 0 ? 'var(--success)' : 'var(--danger)'}">
                ${stats.roi >= 0 ? '+' : ''}${stats.roi.toFixed(2)}%
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Taux de R√©ussite</div>
            <div class="stat-value">${stats.winRate.toFixed(1)}%</div>
            <div class="stat-change">${stats.wonBets}G / ${stats.lostBets}P</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Paris Totaux</div>
            <div class="stat-value">${stats.totalBets}</div>
            <div class="stat-change">${stats.inProgress} en cours</div>
        </div>
    `;

    updateBankrollChart(br);
    updateWinLossChart(br);
    updateRecentBets(br);
}

function updateBankrollChart(br) {
    const ctx = document.getElementById('bankrollChart');
    let running = br.initialAmount;
    const sorted = [...br.bets]
        .filter(b => b.status !== 'en-cours')
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    const data = [br.initialAmount];
    const labels = ['D√©part'];

    sorted.forEach((bet, idx) => {
        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
        if (bet.status === 'gagne') running += (bet.amount * odds) - bet.amount;
        else if (bet.status === 'perdu') running -= bet.amount;
        else if (bet.status === 'cashout') running += (bet.cashoutAmount || 0) - bet.amount;
        data.push(running);
        labels.push(`#${idx + 1}`);
    });

    if (charts.bankroll) charts.bankroll.destroy();

    const isDark = document.body.getAttribute('data-theme') === 'dark';
    
    charts.bankroll = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Bankroll (‚Ç¨)',
                data,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                },
                x: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                }
            }
        }
    });
}

function updateWinLossChart(br) {
    const ctx = document.getElementById('winLossChart');
    const stats = calculateStats(br);

    if (charts.winLoss) charts.winLoss.destroy();

    const isDark = document.body.getAttribute('data-theme') === 'dark';

    charts.winLoss = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Gagn√©s', 'Perdus', 'Cashout', 'En cours'],
            datasets: [{
                data: [stats.wonBets, stats.lostBets, stats.cashoutBets, stats.inProgress],
                backgroundColor: ['#10b981', '#ef4444', '#3b82f6', '#f59e0b'],
                borderWidth: 4,
                borderColor: isDark ? '#1e293b' : '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: isDark ? '#f1f5f9' : '#111827', font: { size: 12, weight: 600 } }
                }
            }
        }
    });
}

function updateRecentBets(br) {
    const container = document.getElementById('recentBetsTable');
    const recent = [...br.bets]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);

    if (recent.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><p class="empty-text">Aucun pari</p></div>';
        return;
    }

    container.innerHTML = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Pari</th>
                        <th>Mise</th>
                        <th>Cote</th>
                        <th>Statut</th>
                        <th>R√©sultat</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${recent.map(bet => {
                        const date = new Date(bet.date).toLocaleDateString('fr-FR');
                        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;

                        return `
                            <tr>
                                <td>${date}</td>
                                <td><span class="badge info">${bet.type}</span></td>
                                <td><span style="font-size:1.15em;vertical-align:middle;margin-right:4px;">${getSportIcon(bet.sport || bet.matches?.[0]?.sport)}</span> <strong>${bet.name}</strong></td>
                                <td>${bet.amount.toFixed(2)} ‚Ç¨</td>
                                <td>${odds ? odds.toFixed(2) : '-'}</td>
                                <td>${renderStatusBadge(bet)}</td>
                                <td style="color: ${getResultColor(bet)}; font-weight: 700;">${getResultText(bet)}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="editBet('${bet.id}')" style="margin-right: 4px;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBet('${bet.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ===================================
// BETS PAGE
// ===================================
function updateBetsPage() {
    renderBankrollSelector('bankrollSelectorBets');
    const br = getCurrentBankroll();
    updateFilters(br);
    updateBetsTable(br);
}

function updateFilters(br) {
    const sports = [...new Set(br.bets.map(b => b.sport || b.matches?.[0]?.sport).filter(Boolean))];
    const bookmakers = [...new Set(br.bets.map(b => b.bookmaker).filter(b => b && b !== '-'))];

    const sportVal = document.getElementById('filterSport').value;
    const bmVal = document.getElementById('filterBookmaker').value;

    document.getElementById('filterSport').innerHTML = '<option value="">Sport</option>' +
        sports.map(s => `<option value="${s}" ${s === sportVal ? 'selected' : ''}>${getSportIcon(s)} ${s}</option>`).join('');

    document.getElementById('filterBookmaker').innerHTML = '<option value="">Bookmaker</option>' +
        bookmakers.map(b => `<option value="${b}" ${b === bmVal ? 'selected' : ''}>${b}</option>`).join('');
}

function updateBetsTable(br) {
    const typeFilter = document.getElementById('filterType').value;
    const sportFilter = document.getElementById('filterSport').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const bookmakerFilter = document.getElementById('filterBookmaker').value;

    let filtered = br.bets.filter(bet => {
        if (typeFilter && bet.type !== typeFilter) return false;
        if (sportFilter) {
            const betSport = bet.sport || bet.matches?.[0]?.sport;
            if (betSport !== sportFilter) return false;
        }
        if (statusFilter && bet.status !== statusFilter) return false;
        if (bookmakerFilter && bet.bookmaker !== bookmakerFilter) return false;
        return true;
    });

    const container = document.getElementById('betsTable');

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><p class="empty-text">Aucun pari</p></div>';
        return;
    }

    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

    container.innerHTML = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Pari</th>
                        <th>D√©tails</th>
                        <th>Mise</th>
                        <th>Cote</th>
                        <th>Statut</th>
                        <th>R√©sultat</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filtered.map(bet => {
                        const date = new Date(bet.date).toLocaleDateString('fr-FR');
                        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;

                        let details = '';
                        if (bet.type === 'simple') details = `<span title="${bet.sport || ''}" style="font-size:1.2em;vertical-align:middle;">${getSportIcon(bet.sport)}</span> ${bet.match || '-'}`;
                        else if (bet.type === 'combine') details = `${bet.matches.length} matchs`;
                        else if (bet.type === 'systeme') details = `${bet.systemType} (${bet.numBets} paris)`;

                        return `
                            <tr>
                                <td>${date}</td>
                                <td><span class="badge info">${bet.type}</span></td>
                                <td><span style="font-size:1.15em;vertical-align:middle;margin-right:4px;">${getSportIcon(bet.sport || bet.matches?.[0]?.sport)}</span> <strong>${bet.name}</strong></td>
                                <td>${details}</td>
                                <td>${bet.amount.toFixed(2)} ‚Ç¨</td>
                                <td>${odds ? odds.toFixed(2) : '-'}</td>
                                <td>${renderStatusBadge(bet)}</td>
                                <td style="color: ${getResultColor(bet)}; font-weight: 700;">${getResultText(bet)}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="editBet('${bet.id}')" style="margin-right: 4px;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBet('${bet.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

document.getElementById('filterType').addEventListener('change', () => {
    const br = getCurrentBankroll();
    updateBetsTable(br);
});
document.getElementById('filterSport').addEventListener('change', () => {
    const br = getCurrentBankroll();
    updateBetsTable(br);
});
document.getElementById('filterStatus').addEventListener('change', () => {
    const br = getCurrentBankroll();
    updateBetsTable(br);
});
document.getElementById('filterBookmaker').addEventListener('change', () => {
    const br = getCurrentBankroll();
    updateBetsTable(br);
});

async function deleteBet(id) {
    const confirmed = await customConfirm(
        'Supprimer ce pari ?',
        'Cette action est irr√©versible. Le pari sera d√©finitivement supprim√©.',
        'üóëÔ∏è',
        'Supprimer',
        true
    );
    if (confirmed) {
        const br = getCurrentBankroll();
        const bet = br.bets.find(b => String(b.id) === String(id));
        
        if (!bet) return;
        
        // Reverse bookmaker balance
        if (bet.bookmaker && bet.bookmaker !== '-') {
            if (bet.status === 'gagne') {
                const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
                if (br.bookmakers[bet.bookmaker]) {
                    br.bookmakers[bet.bookmaker].current -= (bet.amount * odds) - bet.amount;
                }
            } else if (bet.status === 'perdu') {
                if (br.bookmakers[bet.bookmaker]) {
                    br.bookmakers[bet.bookmaker].current += bet.amount;
                }
            }
        }
        
        br.bets = br.bets.filter(b => String(b.id) !== String(id));
        updateBankrollAmount(br);
        saveData();
        updateApp();
    }
}

// ===================================
// ANALYZER (same as before, kept for brevity)
// ===================================
function updateAnalyzer() {
    renderBankrollSelector('bankrollSelectorAnalyzer');
    const br = getCurrentBankroll();
    const stats = calculateStats(br);

    const avgStake = stats.totalBets > 0 ? (br.bets.reduce((s, b) => s + b.amount, 0) / stats.totalBets) : 0;
    const avgOdds = stats.totalBets > 0 ? (br.bets.reduce((s, b) => s + (b.type === 'combine' ? b.totalOdds : b.odds || 0), 0) / stats.totalBets) : 0;

    document.getElementById('analyzerStats').innerHTML = `
        <div class="stat-card">
            <div class="stat-label">Mise Moyenne</div>
            <div class="stat-value">${avgStake.toFixed(2)} ‚Ç¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Cote Moyenne</div>
            <div class="stat-value">${avgOdds.toFixed(2)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Yield</div>
            <div class="stat-value" style="color: ${stats.roi >= 0 ? 'var(--success)' : 'var(--danger)'}">
                ${stats.roi >= 0 ? '+' : ''}${stats.roi.toFixed(2)}%
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">S√©rie Max</div>
            <div class="stat-value">${calculateStreak(br)}</div>
        </div>
    `;

    updateSportChart(br);
    updateBookmakerChart(br);
    updateConfidenceChart(br);
    updateOddsChart(br);
}

function calculateStreak(br) {
    const sorted = [...br.bets]
        .filter(b => b.status !== 'en-cours')
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    let current = 0;
    let max = 0;

    sorted.forEach(bet => {
        if (bet.status === 'gagne') {
            current++;
            max = Math.max(max, current);
        } else {
            current = 0;
        }
    });

    return max;
}

function updateSportChart(br) {
    const ctx = document.getElementById('sportChart');
    const sportStats = {};
    
    br.bets.forEach(bet => {
        const sport = bet.sport || bet.matches?.[0]?.sport || 'Autre';
        if (!sportStats[sport]) sportStats[sport] = { won: 0, lost: 0, profit: 0, stake: 0 };
        
        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
        if (bet.status === 'gagne') {
            sportStats[sport].won++;
            sportStats[sport].profit += (bet.amount * odds) - bet.amount;
            sportStats[sport].stake += bet.amount;
        } else if (bet.status === 'perdu') {
            sportStats[sport].lost++;
            sportStats[sport].profit -= bet.amount;
            sportStats[sport].stake += bet.amount;
        } else if (bet.status === 'cashout') {
            sportStats[sport].profit += (bet.cashoutAmount || 0) - bet.amount;
            sportStats[sport].stake += bet.amount;
        }
    });

    const labels = Object.keys(sportStats);
    const labelsWithIcons = labels.map(s => `${getSportIcon(s)} ${s}`);
    const roi = labels.map(s => {
        const st = sportStats[s];
        return st.stake > 0 ? (st.profit / st.stake) * 100 : 0;
    });

    if (charts.sport) charts.sport.destroy();

    const isDark = document.body.getAttribute('data-theme') === 'dark';

    charts.sport = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labelsWithIcons,
            datasets: [{
                label: 'ROI (%)',
                data: roi,
                backgroundColor: roi.map(r => r >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: roi.map(r => r >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                },
                x: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                }
            }
        }
    });
}

function updateBookmakerChart(br) {
    const ctx = document.getElementById('bookmakerChart');
    const bmStats = {};
    
    br.bets.forEach(bet => {
        const bm = bet.bookmaker || 'Autre';
        if (bm === '-') return;
        
        if (!bmStats[bm]) bmStats[bm] = { won: 0, lost: 0, profit: 0, stake: 0 };
        
        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
        if (bet.status === 'gagne') {
            bmStats[bm].won++;
            bmStats[bm].profit += (bet.amount * odds) - bet.amount;
            bmStats[bm].stake += bet.amount;
        } else if (bet.status === 'perdu') {
            bmStats[bm].lost++;
            bmStats[bm].profit -= bet.amount;
            bmStats[bm].stake += bet.amount;
        } else if (bet.status === 'cashout') {
            bmStats[bm].profit += (bet.cashoutAmount || 0) - bet.amount;
            bmStats[bm].stake += bet.amount;
        }
    });

    const labels = Object.keys(bmStats);
    const roi = labels.map(bm => {
        const st = bmStats[bm];
        return st.stake > 0 ? (st.profit / st.stake) * 100 : 0;
    });

    if (charts.bookmaker) charts.bookmaker.destroy();

    const isDark = document.body.getAttribute('data-theme') === 'dark';

    charts.bookmaker = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'ROI (%)',
                data: roi,
                backgroundColor: roi.map(r => r >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: roi.map(r => r >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                },
                y: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                }
            }
        }
    });
}

function updateConfidenceChart(br) {
    const ctx = document.getElementById('confidenceChart');
    const ranges = {
        '0-25%': { won: 0, lost: 0, profit: 0, stake: 0 },
        '26-50%': { won: 0, lost: 0, profit: 0, stake: 0 },
        '51-75%': { won: 0, lost: 0, profit: 0, stake: 0 },
        '76-100%': { won: 0, lost: 0, profit: 0, stake: 0 }
    };

    br.bets.forEach(bet => {
        const conf = bet.confidence || 50;
        let range;
        if (conf <= 25) range = '0-25%';
        else if (conf <= 50) range = '26-50%';
        else if (conf <= 75) range = '51-75%';
        else range = '76-100%';

        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
        if (bet.status === 'gagne') {
            ranges[range].won++;
            ranges[range].profit += (bet.amount * odds) - bet.amount;
            ranges[range].stake += bet.amount;
        } else if (bet.status === 'perdu') {
            ranges[range].lost++;
            ranges[range].profit -= bet.amount;
            ranges[range].stake += bet.amount;
        } else if (bet.status === 'cashout') {
            ranges[range].profit += (bet.cashoutAmount || 0) - bet.amount;
            ranges[range].stake += bet.amount;
        }
    });

    const labels = Object.keys(ranges);
    const roi = labels.map(r => {
        const st = ranges[r];
        return st.stake > 0 ? (st.profit / st.stake) * 100 : 0;
    });

    if (charts.confidence) charts.confidence.destroy();

    const isDark = document.body.getAttribute('data-theme') === 'dark';

    charts.confidence = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'ROI (%)',
                data: roi,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                },
                x: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                }
            }
        }
    });
}

function updateOddsChart(br) {
    const ctx = document.getElementById('oddsChart');
    const ranges = {
        '1.0-1.5': { won: 0, lost: 0, profit: 0, stake: 0 },
        '1.51-2.0': { won: 0, lost: 0, profit: 0, stake: 0 },
        '2.01-3.0': { won: 0, lost: 0, profit: 0, stake: 0 },
        '3.0+': { won: 0, lost: 0, profit: 0, stake: 0 }
    };

    br.bets.forEach(bet => {
        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
        if (!odds) return;
        
        let range;
        if (odds <= 1.5) range = '1.0-1.5';
        else if (odds <= 2.0) range = '1.51-2.0';
        else if (odds <= 3.0) range = '2.01-3.0';
        else range = '3.0+';

        if (bet.status === 'gagne') {
            ranges[range].won++;
            ranges[range].profit += (bet.amount * odds) - bet.amount;
            ranges[range].stake += bet.amount;
        } else if (bet.status === 'perdu') {
            ranges[range].lost++;
            ranges[range].profit -= bet.amount;
            ranges[range].stake += bet.amount;
        } else if (bet.status === 'cashout') {
            ranges[range].profit += (bet.cashoutAmount || 0) - bet.amount;
            ranges[range].stake += bet.amount;
        }
    });

    const labels = Object.keys(ranges);
    const roi = labels.map(r => {
        const st = ranges[r];
        return st.stake > 0 ? (st.profit / st.stake) * 100 : 0;
    });

    if (charts.odds) charts.odds.destroy();

    const isDark = document.body.getAttribute('data-theme') === 'dark';

    charts.odds = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'ROI (%)',
                data: roi,
                backgroundColor: roi.map(r => r >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: roi.map(r => r >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                },
                x: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                }
            }
        }
    });
}

// ===================================
// OPTIMIZER
// ===================================
function updateOptimizer() {
    const br = getCurrentBankroll();
    document.getElementById('flatValue').value = '';
    document.getElementById('percentageValue').value = '2';
}

document.getElementById('strategyType').addEventListener('change', (e) => {
    const type = e.target.value;
    document.getElementById('flatAmount').style.display = type === 'flat' ? 'block' : 'none';
    document.getElementById('percentageAmount').style.display = type === 'percentage' ? 'block' : 'none';
});

document.getElementById('strategyForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const br = getCurrentBankroll();
    const type = document.getElementById('strategyType').value;
    let stake = 0;

    if (type === 'flat') {
        stake = parseFloat(document.getElementById('flatValue').value) || 0;
    } else if (type === 'percentage') {
        const pct = parseFloat(document.getElementById('percentageValue').value) || 2;
        stake = (br.currentAmount * pct) / 100;
    } else if (type === 'kelly') {
        stake = (br.currentAmount * 0.02);
    }

    document.getElementById('strategyResult').innerHTML = `
        <div style="background: var(--bg-secondary); margin-top: 24px; padding: 20px; border-radius: 12px; border: 2px solid var(--primary);">
            <div style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px;">Mise Recommand√©e</div>
            <div style="font-size: 2.5em; font-weight: 800; color: var(--primary);">${stake.toFixed(2)} ‚Ç¨</div>
            <p style="color: var(--text-secondary); margin-top: 12px;">
                <i class="fas fa-info-circle"></i> ${((stake / br.currentAmount) * 100).toFixed(2)}% de votre bankroll
            </p>
        </div>
    `;
});

document.getElementById('simForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const numBets = parseInt(document.getElementById('simBets').value);
    const winRate = parseFloat(document.getElementById('simWinRate').value) / 100;
    const avgOdds = parseFloat(document.getElementById('simOdds').value);
    
    const br = getCurrentBankroll();
    let balance = br.currentAmount;
    const data = [balance];
    const labels = ['0'];

    for (let i = 1; i <= numBets; i++) {
        const stake = balance * 0.02;
        const won = Math.random() < winRate;
        
        if (won) balance += stake * (avgOdds - 1);
        else balance -= stake;
        
        data.push(balance);
        labels.push(i.toString());
    }

    const ctx = document.getElementById('simChart');
    
    if (charts.sim) charts.sim.destroy();

    const isDark = document.body.getAttribute('data-theme') === 'dark';

    charts.sim = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Bankroll (‚Ç¨)',
                data,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                },
                x: {
                    ticks: { 
                        color: isDark ? '#94a3b8' : '#6b7280',
                        maxTicksLimit: 10
                    },
                    grid: { color: isDark ? '#334155' : '#e5e7eb' }
                }
            }
        }
    });
});

// ===================================
// EXPORT / IMPORT
// ===================================
function exportData() {
    const data = { bankrolls, exportDate: new Date().toISOString(), version: '2.0' };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bet-tracker-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importData() {
    document.getElementById('importFile').click();
}

document.getElementById('importFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const data = JSON.parse(event.target.result);
            const confirmed = await customConfirm(
                'Importer les donn√©es ?',
                'Vos donn√©es actuelles seront remplac√©es par les donn√©es import√©es.',
                'üì•',
                'Importer',
                false
            );
            if (confirmed) {
                bankrolls = data.bankrolls || [];
                if (bankrolls.length > 0) currentBankrollId = bankrolls[0].id;
                saveData();
                updateApp();
                alert('Import r√©ussi !');
            }
        } catch (err) {
            alert('Fichier invalide');
        }
    };
    reader.readAsText(file);
    e.target.value = '';
});

async function resetAll() {
    const first = await customConfirm(
        'Supprimer TOUTES les donn√©es ?',
        'Cette action supprimera tous vos paris, bankrolls et param√®tres.',
        '‚ö†Ô∏è',
        'Continuer',
        true
    );
    if (first) {
        const second = await customConfirm(
            'Derni√®re confirmation',
            '√ätes-vous vraiment s√ªr ? Cette action est irr√©versible.',
            'üö®',
            'Tout supprimer',
            true
        );
        if (second) {
            localStorage.clear();
            location.reload();
        }
    }
}

// ===================================
// GLOBAL UPDATE
// ===================================
function updateApp() {
    const page = document.querySelector('.page.active').id;
    
    if (page === 'dashboard') updateDashboard();
    else if (page === 'bets') updateBetsPage();
    else if (page === 'analyzer') updateAnalyzer();
    else if (page === 'optimizer') updateOptimizer();
    else if (page === 'pronostics') updatePronostics();
    else if (page === 'bankrolls') updateBankrollsPage();
}

// ===================================
// PRONOSTICS
// ===================================
function updatePronostics() {
    updatePronoStrengths();
    updatePronoRecommendations();
}

function getStatsBy(field) {
    const br = getCurrentBankroll();
    const stats = {};
    
    br.bets.forEach(bet => {
        let key;
        if (field === 'sport') key = bet.sport || bet.matches?.[0]?.sport || 'Autre';
        else if (field === 'league') key = bet.league || '-';
        else if (field === 'oddsRange') {
            const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
            if (!odds) return;
            if (odds <= 1.5) key = '1.0-1.5';
            else if (odds <= 2.0) key = '1.51-2.0';
            else if (odds <= 3.0) key = '2.01-3.0';
            else key = '3.0+';
        }
        
        if (!key || key === '-') return;
        if (!stats[key]) stats[key] = { won: 0, lost: 0, total: 0, profit: 0, stake: 0, avgOdds: 0, oddsSum: 0 };
        
        const odds = bet.type === 'combine' ? bet.totalOdds : bet.odds;
        stats[key].oddsSum += odds || 0;
        
        if (bet.status === 'gagne') {
            stats[key].won++;
            stats[key].total++;
            stats[key].profit += (bet.amount * odds) - bet.amount;
            stats[key].stake += bet.amount;
        } else if (bet.status === 'perdu') {
            stats[key].lost++;
            stats[key].total++;
            stats[key].profit -= bet.amount;
            stats[key].stake += bet.amount;
        } else if (bet.status === 'cashout') {
            stats[key].total++;
            stats[key].profit += (bet.cashoutAmount || 0) - bet.amount;
            stats[key].stake += bet.amount;
        }
    });
    
    // Calculate averages
    Object.keys(stats).forEach(key => {
        const s = stats[key];
        s.winRate = s.total > 0 ? (s.won / s.total) * 100 : 0;
        s.roi = s.stake > 0 ? (s.profit / s.stake) * 100 : 0;
        s.avgOdds = s.total > 0 ? s.oddsSum / s.total : 0;
    });
    
    return stats;
}

function updatePronoStrengths() {
    const container = document.getElementById('pronoStrengths');
    const br = getCurrentBankroll();
    
    if (br.bets.length < 3) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px;">
                <div class="empty-icon">üìä</div>
                <p class="empty-text">Ajoutez au moins 3 paris pour voir vos points forts</p>
            </div>`;
        return;
    }
    
    const sportStats = getStatsBy('sport');
    const oddsStats = getStatsBy('oddsRange');
    
    // Find best performing areas
    const strengths = [];
    
    Object.entries(sportStats).forEach(([sport, s]) => {
        if (s.total >= 2) {
            strengths.push({
                type: 'sport',
                label: sport,
                winRate: s.winRate,
                roi: s.roi,
                total: s.total,
                profit: s.profit
            });
        }
    });
    
    Object.entries(oddsStats).forEach(([range, s]) => {
        if (s.total >= 2) {
            strengths.push({
                type: 'odds',
                label: `Cotes ${range}`,
                winRate: s.winRate,
                roi: s.roi,
                total: s.total,
                profit: s.profit
            });
        }
    });
    
    strengths.sort((a, b) => b.roi - a.roi);
    
    if (strengths.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px;">
                <div class="empty-icon">üéØ</div>
                <p class="empty-text">Pas assez de donn√©es par cat√©gorie</p>
            </div>`;
        return;
    }
    
    container.innerHTML = strengths.slice(0, 6).map(s => {
        const icon = s.type === 'sport' ? '‚öΩ' : 'üìà';
        const roiColor = s.roi >= 0 ? 'var(--success)' : 'var(--danger)';
        const profitColor = s.profit >= 0 ? 'var(--success)' : 'var(--danger)';
        
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.3em;">${icon}</span>
                    <div>
                        <div style="font-weight: 700;">${s.label}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">${s.total} paris ¬∑ ${s.winRate.toFixed(0)}% r√©ussite</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; color: ${roiColor};">${s.roi >= 0 ? '+' : ''}${s.roi.toFixed(1)}% ROI</div>
                    <div style="font-size: 0.85em; color: ${profitColor};">${s.profit >= 0 ? '+' : ''}${s.profit.toFixed(2)} ‚Ç¨</div>
                </div>
            </div>
        `;
    }).join('');
}

function analyzeProno() {
    const sport = document.getElementById('pronoSport').value;
    const league = document.getElementById('pronoLeague').value;
    const team1 = document.getElementById('pronoTeam1').value;
    const team2 = document.getElementById('pronoTeam2').value;
    const pronoType = document.getElementById('pronoType').value;
    const proposedOdds = parseFloat(document.getElementById('pronoOdds').value);
    
    if (!team1 || !team2) {
        customConfirm('Champs manquants', 'Veuillez renseigner les deux √©quipes/joueurs.', '‚ö†Ô∏è', 'OK', false);
        return;
    }
    
    const br = getCurrentBankroll();
    const sportStats = getStatsBy('sport');
    const oddsStats = getStatsBy('oddsRange');
    const leagueStats = getStatsBy('league');
    
    // Analyze sport performance
    const mySportStats = sportStats[sport] || { winRate: 50, roi: 0, total: 0, avgOdds: 0 };
    
    // Analyze odds range performance
    let oddsRange;
    if (proposedOdds <= 1.5) oddsRange = '1.0-1.5';
    else if (proposedOdds <= 2.0) oddsRange = '1.51-2.0';
    else if (proposedOdds <= 3.0) oddsRange = '2.01-3.0';
    else oddsRange = '3.0+';
    const myOddsStats = oddsStats[oddsRange] || { winRate: 50, roi: 0, total: 0 };
    
    // League stats
    const myLeagueStats = league ? (leagueStats[league] || null) : null;
    
    // Calculate confidence score (weighted average of factors)
    let confidenceScore = 50;
    let factors = [];
    let totalWeight = 0;
    
    if (mySportStats.total >= 3) {
        const weight = Math.min(mySportStats.total, 20);
        confidenceScore += (mySportStats.winRate - 50) * 0.3 * (weight / 20);
        totalWeight += weight;
        factors.push({
            label: `${sport}`,
            value: mySportStats.winRate,
            detail: `${mySportStats.total} paris, ${mySportStats.winRate.toFixed(0)}% r√©ussite`,
            positive: mySportStats.winRate >= 50
        });
    }
    
    if (myOddsStats.total >= 3) {
        const weight = Math.min(myOddsStats.total, 20);
        confidenceScore += (myOddsStats.roi) * 0.2;
        totalWeight += weight;
        factors.push({
            label: `Cotes ${oddsRange}`,
            value: myOddsStats.roi,
            detail: `ROI de ${myOddsStats.roi.toFixed(1)}% sur ${myOddsStats.total} paris`,
            positive: myOddsStats.roi >= 0
        });
    }
    
    if (myLeagueStats && myLeagueStats.total >= 2) {
        factors.push({
            label: league,
            value: myLeagueStats.winRate,
            detail: `${myLeagueStats.total} paris, ${myLeagueStats.winRate.toFixed(0)}% r√©ussite`,
            positive: myLeagueStats.winRate >= 50
        });
        confidenceScore += (myLeagueStats.winRate - 50) * 0.2;
    }
    
    confidenceScore = Math.max(10, Math.min(90, confidenceScore));
    
    // Value bet detection
    const impliedProb = proposedOdds ? (1 / proposedOdds) * 100 : 50;
    const isValueBet = confidenceScore > impliedProb;
    
    // Recommended stake (Kelly-inspired)
    const edge = (confidenceScore / 100) - (impliedProb / 100);
    const kellyFraction = proposedOdds ? Math.max(0, edge / (proposedOdds - 1)) : 0;
    const recommendedStake = Math.min(br.currentAmount * kellyFraction, br.currentAmount * 0.05);
    
    // Risk level
    let riskLevel, riskColor, riskIcon;
    if (proposedOdds <= 1.5) { riskLevel = 'Faible'; riskColor = 'var(--success)'; riskIcon = 'üü¢'; }
    else if (proposedOdds <= 2.5) { riskLevel = 'Mod√©r√©'; riskColor = 'var(--warning)'; riskIcon = 'üü°'; }
    else { riskLevel = '√âlev√©'; riskColor = 'var(--danger)'; riskIcon = 'üî¥'; }
    
    const container = document.getElementById('pronoResult');
    container.innerHTML = `
        <div style="margin-top: 24px; padding: 24px; background: var(--bg-secondary); border-radius: 16px; border: 2px solid ${isValueBet ? 'var(--success)' : 'var(--border)'};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">${team1} vs ${team2}</div>
                    <div style="font-size: 1.3em; font-weight: 800;">${pronoType === '1' ? team1 : pronoType === '2' ? team2 : pronoType === 'N' ? 'Match Nul' : pronoType}</div>
                </div>
                ${isValueBet ? '<span class="badge success" style="font-size: 0.85em;">VALUE BET</span>' : ''}
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 16px; background: var(--bg-card); border-radius: 12px;">
                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 6px;">Confiance</div>
                    <div style="font-size: 1.8em; font-weight: 800; color: ${confidenceScore >= 55 ? 'var(--success)' : confidenceScore >= 45 ? 'var(--warning)' : 'var(--danger)'};">${confidenceScore.toFixed(0)}%</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--bg-card); border-radius: 12px;">
                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 6px;">Risque</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: ${riskColor};">${riskIcon} ${riskLevel}</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--bg-card); border-radius: 12px;">
                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 6px;">Mise conseill√©e</div>
                    <div style="font-size: 1.8em; font-weight: 800; color: var(--primary);">${recommendedStake.toFixed(2)} ‚Ç¨</div>
                </div>
            </div>
            
            ${proposedOdds ? `
                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-card); border-radius: 10px; font-size: 0.9em;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: var(--text-secondary);">Probabilit√© implicite (cote)</span>
                        <span style="font-weight: 700;">${impliedProb.toFixed(1)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Votre estimation</span>
                        <span style="font-weight: 700; color: ${isValueBet ? 'var(--success)' : 'var(--danger)'};">${confidenceScore.toFixed(1)}%</span>
                    </div>
                    ${isValueBet ? `<div style="margin-top: 8px; color: var(--success); font-size: 0.85em;"><i class="fas fa-check-circle"></i> La cote semble favorable selon votre historique</div>` : 
                    `<div style="margin-top: 8px; color: var(--danger); font-size: 0.85em;"><i class="fas fa-exclamation-circle"></i> La cote ne semble pas avantageuse selon votre historique</div>`}
                </div>
            ` : ''}
            
            <div style="font-size: 0.85em; font-weight: 700; margin-bottom: 10px; color: var(--text-secondary);">FACTEURS D'ANALYSE</div>
            ${factors.length > 0 ? factors.map(f => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${f.positive ? 'var(--success)' : 'var(--danger)'};">${f.positive ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <span style="font-weight: 600;">${f.label}</span>
                    </div>
                    <span style="color: var(--text-secondary); font-size: 0.9em;">${f.detail}</span>
                </div>
            `).join('') : `
                <div style="padding: 16px; text-align: center; color: var(--text-secondary); font-size: 0.9em;">
                    Pas assez de donn√©es historiques pour ce type de pari.<br>Continuez √† parier pour affiner les pronostics !
                </div>
            `}
            
            <div style="margin-top: 16px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; font-size: 0.85em; color: var(--text-secondary);">
                <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                Ces pronostics sont bas√©s sur <strong>votre historique de paris</strong> et ne garantissent pas le r√©sultat. Plus vous avez de paris enregistr√©s, plus l'analyse sera pr√©cise.
            </div>
        </div>
    `;
}

function updatePronoRecommendations() {
    const container = document.getElementById('pronoRecommendations');
    const br = getCurrentBankroll();
    
    if (br.bets.length < 5) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px;">
                <div class="empty-icon">üí°</div>
                <p class="empty-text">Ajoutez au moins 5 paris pour obtenir des recommandations personnalis√©es</p>
            </div>`;
        return;
    }
    
    const sportStats = getStatsBy('sport');
    const oddsStats = getStatsBy('oddsRange');
    const stats = calculateStats(br);
    
    const tips = [];
    
    // Best sport
    let bestSport = null, bestSportROI = -Infinity;
    Object.entries(sportStats).forEach(([sport, s]) => {
        if (s.total >= 3 && s.roi > bestSportROI) {
            bestSport = sport;
            bestSportROI = s.roi;
        }
    });
    if (bestSport && bestSportROI > 0) {
        tips.push({ icon: 'üèÜ', title: `Focalisez-vous sur le ${bestSport}`, desc: `Votre meilleur sport avec un ROI de +${bestSportROI.toFixed(1)}%. Continuez sur cette lanc√©e !`, type: 'success' });
    }
    
    // Worst sport
    let worstSport = null, worstSportROI = Infinity;
    Object.entries(sportStats).forEach(([sport, s]) => {
        if (s.total >= 3 && s.roi < worstSportROI) {
            worstSport = sport;
            worstSportROI = s.roi;
        }
    });
    if (worstSport && worstSportROI < -10 && worstSport !== bestSport) {
        tips.push({ icon: '‚ö†Ô∏è', title: `Attention au ${worstSport}`, desc: `ROI de ${worstSportROI.toFixed(1)}% ‚Äî r√©duisez vos mises ou analysez mieux ce sport.`, type: 'warning' });
    }
    
    // Best odds range
    let bestOdds = null, bestOddsROI = -Infinity;
    Object.entries(oddsStats).forEach(([range, s]) => {
        if (s.total >= 3 && s.roi > bestOddsROI) {
            bestOdds = range;
            bestOddsROI = s.roi;
        }
    });
    if (bestOdds && bestOddsROI > 0) {
        tips.push({ icon: 'üìà', title: `Cotes ${bestOdds} : votre zone de confort`, desc: `ROI de +${bestOddsROI.toFixed(1)}% sur cette tranche de cotes.`, type: 'success' });
    }
    
    // Bankroll management
    const avgStake = br.bets.reduce((s, b) => s + b.amount, 0) / br.bets.length;
    const stakePercent = (avgStake / br.currentAmount) * 100;
    if (stakePercent > 5) {
        tips.push({ icon: 'üéØ', title: 'R√©duisez vos mises', desc: `Votre mise moyenne (${avgStake.toFixed(2)} ‚Ç¨) repr√©sente ${stakePercent.toFixed(1)}% de votre bankroll. Visez 1-3%.`, type: 'danger' });
    } else if (stakePercent <= 3) {
        tips.push({ icon: '‚úÖ', title: 'Bonne gestion de bankroll', desc: `Mise moyenne de ${stakePercent.toFixed(1)}% de votre bankroll. C'est dans la zone recommand√©e.`, type: 'success' });
    }
    
    // Win rate trend
    const recentBets = [...br.bets].filter(b => b.status !== 'en-cours').sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
    if (recentBets.length >= 5) {
        const recentWinRate = (recentBets.filter(b => b.status === 'gagne').length / recentBets.length) * 100;
        if (recentWinRate >= 60) {
            tips.push({ icon: 'üî•', title: 'Vous √™tes en forme !', desc: `${recentWinRate.toFixed(0)}% de r√©ussite sur vos 10 derniers paris. Profitez-en !`, type: 'success' });
        } else if (recentWinRate <= 30) {
            tips.push({ icon: '‚ùÑÔ∏è', title: 'S√©rie difficile', desc: `${recentWinRate.toFixed(0)}% de r√©ussite r√©cemment. Envisagez de r√©duire vos mises ou faire une pause.`, type: 'danger' });
        }
    }
    
    if (tips.length === 0) {
        tips.push({ icon: 'üìä', title: 'Continuez √† parier', desc: 'Plus vous enregistrez de paris, plus les recommandations seront pertinentes.', type: 'info' });
    }
    
    const typeColors = {
        success: 'var(--success)',
        warning: 'var(--warning)',
        danger: 'var(--danger)',
        info: 'var(--primary)'
    };
    
    container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
        ${tips.map(tip => `
            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 14px; border-left: 4px solid ${typeColors[tip.type]};">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="font-size: 1.4em;">${tip.icon}</span>
                    <span style="font-weight: 700; font-size: 1em;">${tip.title}</span>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0;">${tip.desc}</p>
            </div>
        `).join('')}
    </div>`;
}

// ===================================
// THESPORTSDB API - MATCHS DU JOUR
// ===================================
const SPORTSDB_BASE = 'https://www.thesportsdb.com/api/v1/json/123';
const CORS_PROXIES = [
    'https://corsproxy.io/?',
    'https://api.allorigins.win/raw?url='
];
let currentProxyIndex = 0;
let todayMatchesData = [];
let matchesDateOffset = 0;

const sportIconMap = {
    'Soccer': '‚öΩ', 'Football': '‚öΩ',
    'Basketball': 'üèÄ',
    'Tennis': 'üéæ',
    'Ice Hockey': 'üèí', 'Hockey': 'üèí',
    'Baseball': '‚öæ',
    'Fighting': 'ü•ä', 'MMA': 'ü•ä',
    'Rugby': 'üèâ',
    'Motorsport': 'üèéÔ∏è',
    'American Football': 'üèà',
    'Volleyball': 'üèê',
    'Handball': 'ü§æ',
    'Cricket': 'üèè'
};

const sportApiMap = {
    'soccer': 'Soccer',
    'basketball': 'Basketball',
    'tennis': 'Tennis',
    'hockey': 'Ice Hockey',
    'baseball': 'Baseball',
    'mma': 'Fighting',
    'rugby': 'Rugby',
    'motorsport': 'Motorsport'
};

const sportToPronoMap = {
    'Soccer': 'Football',
    'Football': 'Football',
    'Basketball': 'Basketball',
    'Tennis': 'Tennis',
    'Ice Hockey': 'Football',
    'Baseball': 'Football',
    'Fighting': 'MMA',
    'Rugby': 'Football',
    'Motorsport': 'Football',
    'American Football': 'Football'
};

function getMatchDate(offset) {
    const d = new Date();
    d.setDate(d.getDate() + offset);
    return d.toISOString().split('T')[0];
}

function formatMatchDate(offset) {
    const d = new Date();
    d.setDate(d.getDate() + offset);
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    let label = d.toLocaleDateString('fr-FR', options);
    if (offset === 0) label = "Aujourd'hui ‚Äî " + label;
    else if (offset === 1) label = "Demain ‚Äî " + label;
    else if (offset === -1) label = "Hier ‚Äî " + label;
    return label.charAt(0).toUpperCase() + label.slice(1);
}

async function fetchWithProxy(url) {
    for (let i = 0; i < CORS_PROXIES.length; i++) {
        const proxyIdx = (currentProxyIndex + i) % CORS_PROXIES.length;
        const proxy = CORS_PROXIES[proxyIdx];
        try {
            const res = await fetch(proxy + encodeURIComponent(url));
            if (res.ok) {
                currentProxyIndex = proxyIdx;
                return await res.json();
            }
        } catch(e) { /* try next proxy */ }
    }
    return { events: null };
}

// Major league IDs for eventsnextleague.php (returns next 15 events)
const MAJOR_LEAGUES = {
    // Football/Soccer
    4328: 'English Premier League',
    4334: 'Ligue 1',
    4335: 'La Liga',
    4331: 'Bundesliga',
    4332: 'Serie A',
    4337: 'Eredivisie',
    4344: 'Liga Portugal',
    4346: 'MLS',
    4480: 'Champions League',
    4481: 'Europa League',
    4339: 'Turkish Super Lig',
    4336: 'Belgian First Division A',
    4338: 'Liga MX',
    4351: 'Brazilian Serie A',
    4359: 'Chinese Super League',
    4330: 'Scottish Premiership',
    // Basketball
    4387: 'NBA',
    4431: 'EuroLeague Basketball',
    4438: 'Liga ACB',
    4425: 'NBB Brazil',
    // Tennis
    4464: 'ATP Tour',
    4465: 'WTA Tour',
};

async function fetchSportsDBEvents(dateStr) {
    const seenIds = new Set();
    let allEvents = [];

    // Strategy 1: eventsday.php by sport (only foot, basket, tennis)
    const sports = ['Soccer', 'Basketball', 'Tennis'];
    const dayResults = await Promise.allSettled(sports.map(sport =>
        fetchWithProxy(`${SPORTSDB_BASE}/eventsday.php?d=${dateStr}&s=${sport}`)
    ));

    dayResults.forEach(r => {
        if (r.status === 'fulfilled' && r.value && r.value.events) {
            r.value.events.forEach(ev => {
                if (ev.idEvent && !seenIds.has(ev.idEvent)) {
                    seenIds.add(ev.idEvent);
                    allEvents.push(ev);
                }
            });
        }
    });

    // Strategy 2: eventsnextleague.php for major leagues (upcoming events)
    const leagueIds = Object.keys(MAJOR_LEAGUES);
    const batchSize = 8;
    for (let i = 0; i < leagueIds.length; i += batchSize) {
        const batch = leagueIds.slice(i, i + batchSize);
        const leagueResults = await Promise.allSettled(batch.map(id =>
            fetchWithProxy(`${SPORTSDB_BASE}/eventsnextleague.php?id=${id}`)
        ));

        leagueResults.forEach(r => {
            if (r.status === 'fulfilled' && r.value && r.value.events) {
                r.value.events.forEach(ev => {
                    if (ev.idEvent && !seenIds.has(ev.idEvent)) {
                        if (ev.dateEvent === dateStr) {
                            seenIds.add(ev.idEvent);
                            allEvents.push(ev);
                        }
                    }
                });
            }
        });
    }

    // Sort by sport then time
    const sportOrder = { 'Soccer': 1, 'Basketball': 2, 'Tennis': 3 };
    allEvents.sort((a, b) => {
        const sA = sportOrder[a.strSport] || 99;
        const sB = sportOrder[b.strSport] || 99;
        if (sA !== sB) return sA - sB;
        const tA = a.strTime || '99:99';
        const tB = b.strTime || '99:99';
        return tA.localeCompare(tB);
    });

    return allEvents;
}

async function loadTodayMatches() {
    const container = document.getElementById('todayMatchesContainer');
    const btn = document.getElementById('refreshMatchesBtn');
    
    btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Chargement...';
    btn.disabled = true;

    container.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: var(--primary); margin-bottom: 12px;"></i>
            <p style="font-weight: 600;">Chargement des matchs...</p>
        </div>
    `;

    try {
        const dateStr = getMatchDate(matchesDateOffset);
        const events = await fetchSportsDBEvents(dateStr);
        todayMatchesData = events;
        renderMatches(events);
    } catch (err) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 2.5em; margin-bottom: 12px;">üòï</div>
                <p style="font-weight: 600; margin-bottom: 8px;">Impossible de charger les matchs</p>
                <p style="font-size: 0.85em;">V√©rifiez votre connexion internet et r√©essayez.</p>
            </div>
        `;
    } finally {
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualiser';
        btn.disabled = false;
    }
}

function renderMatches(events) {
    const container = document.getElementById('todayMatchesContainer');
    const filter = document.getElementById('liveSportFilter').value;

    let filtered = events;
    if (filter !== 'all') {
        const sportName = sportApiMap[filter];
        if (sportName) {
            filtered = events.filter(e => e.strSport === sportName);
        }
    }

    if (!filtered || filtered.length === 0) {
        container.innerHTML = `
            <div class="matches-date-nav">
                <button onclick="changeMatchDate(-1)"><i class="fas fa-chevron-left"></i></button>
                <span class="matches-date-label">${formatMatchDate(matchesDateOffset)}</span>
                <button onclick="changeMatchDate(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 2.5em; margin-bottom: 12px;">üì≠</div>
                <p style="font-weight: 600; margin-bottom: 8px;">Aucun match trouv√©</p>
                <p style="font-size: 0.85em;">Essayez un autre sport ou une autre date.</p>
            </div>
        `;
        return;
    }

    // Group by league
    const byLeague = {};
    filtered.forEach(ev => {
        const league = ev.strLeague || 'Autre';
        if (!byLeague[league]) byLeague[league] = [];
        byLeague[league].push(ev);
    });

    let html = `
        <div class="matches-date-nav">
            <button onclick="changeMatchDate(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="matches-date-label">${formatMatchDate(matchesDateOffset)}</span>
            <button onclick="changeMatchDate(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 14px;">
            ${filtered.length} match${filtered.length > 1 ? 's' : ''} trouv√©${filtered.length > 1 ? 's' : ''} ‚Ä¢ Cliquez pour pr√©-remplir l'analyse
        </div>
    `;

    Object.entries(byLeague).forEach(([league, matches]) => {
        html += `
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding: 6px 0;">
                    <span style="font-size: 0.82em; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px;">
                        ${sportIconMap[matches[0].strSport] || 'üèüÔ∏è'} ${league}
                    </span>
                    <span style="font-size: 0.75em; color: var(--text-secondary); font-weight: 500;">${matches.length} match${matches.length > 1 ? 's' : ''}</span>
                </div>
                <div class="matches-grid">
        `;

        matches.forEach(ev => {
            const isFinished = ev.intHomeScore !== null && ev.intAwayScore !== null;
            const hasStarted = isFinished; // Simplified check
            const timeStr = ev.strTime ? ev.strTime.substring(0, 5) : '--:--';
            
            let statusHtml;
            if (ev.strStatus && ev.strStatus.toLowerCase().includes('live')) {
                statusHtml = `<span class="match-status-live">LIVE</span>`;
            } else if (isFinished && ev.strStatus && (ev.strStatus.includes('FT') || ev.strStatus.includes('AET') || ev.strStatus === 'Match Finished')) {
                statusHtml = `<span class="match-status-finished">Termin√©</span>`;
            } else {
                statusHtml = `<span class="match-status-upcoming">${timeStr}</span>`;
            }

            const homeThumb = ev.strHomeTeamBadge || '';
            const awayThumb = ev.strAwayTeamBadge || '';

            const scoreOrVs = isFinished
                ? `<div class="match-score">${ev.intHomeScore} - ${ev.intAwayScore}</div>`
                : `<div class="match-vs">VS</div>`;

            html += `
                <div class="match-card" onclick="fillPronoFromMatch('${(ev.strHomeTeam||'').replace(/'/g, "\\'")}', '${(ev.strAwayTeam||'').replace(/'/g, "\\'")}', '${(league||'').replace(/'/g, "\\'")}', '${ev.strSport || 'Soccer'}')">
                    <div class="match-card-teams">
                        <div class="match-team">
                            ${homeThumb ? `<img src="${homeThumb}/tiny" alt="" onerror="this.style.display='none'">` : `<div style="width:40px;height:40px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3em;">${sportIconMap[ev.strSport] || 'üèüÔ∏è'}</div>`}
                            <span class="match-team-name">${ev.strHomeTeam || '?'}</span>
                        </div>
                        ${scoreOrVs}
                        <div class="match-team">
                            ${awayThumb ? `<img src="${awayThumb}/tiny" alt="" onerror="this.style.display='none'">` : `<div style="width:40px;height:40px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3em;">${sportIconMap[ev.strSport] || 'üèüÔ∏è'}</div>`}
                            <span class="match-team-name">${ev.strAwayTeam || '?'}</span>
                        </div>
                    </div>
                    <div class="match-card-footer">
                        ${statusHtml}
                        <button class="match-use-btn" onclick="event.stopPropagation(); fillPronoFromMatch('${(ev.strHomeTeam||'').replace(/'/g, "\\'")}', '${(ev.strAwayTeam||'').replace(/'/g, "\\'")}', '${(league||'').replace(/'/g, "\\'")}', '${ev.strSport || 'Soccer'}')">
                            <i class="fas fa-arrow-right"></i> Analyser
                        </button>
                    </div>
                </div>
            `;
        });

        html += `</div></div>`;
    });

    container.innerHTML = html;
}

function fillPronoFromMatch(team1, team2, league, sport) {
    const pronoSport = sportToPronoMap[sport] || 'Football';
    document.getElementById('pronoSport').value = pronoSport;
    document.getElementById('pronoLeague').value = league;
    document.getElementById('pronoTeam1').value = team1;
    document.getElementById('pronoTeam2').value = team2;

    // Scroll to analysis form
    document.querySelector('#pronostics .grid-2').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Flash effect on form
    const formCard = document.querySelector('#pronostics .grid-2 .card');
    formCard.style.borderColor = 'var(--primary)';
    formCard.style.boxShadow = '0 0 20px rgba(99, 102, 241, 0.2)';
    setTimeout(() => {
        formCard.style.borderColor = '';
        formCard.style.boxShadow = '';
    }, 1500);
}

function changeMatchDate(delta) {
    matchesDateOffset += delta;
    if (matchesDateOffset < -7) matchesDateOffset = -7;
    if (matchesDateOffset > 7) matchesDateOffset = 7;
    loadTodayMatches();
}

// Filter listener
document.getElementById('liveSportFilter').addEventListener('change', () => {
    renderMatches(todayMatchesData);
});

// ===================================
// INIT
// ===================================

// Load from cloud first, then update UI
(async function init() {
    updateDashboard();
    
    // Try loading from cloud
    const loaded = await loadFromCloud();
    if (loaded) {
        updateDashboard();
    }
    
    // Create bin if first time
    if (!JSONBIN_BIN_ID) {
        await createBin();
    }
    
    showCloudInfo();
})();

// Load matches when pronostics page is shown
const origNav = document.querySelectorAll('.nav-item');
let matchesLoaded = false;
origNav.forEach(item => {
    item.addEventListener('click', () => {
        if (item.dataset.page === 'pronostics' && !matchesLoaded) {
            matchesLoaded = true;
            setTimeout(() => loadTodayMatches(), 300);
        }
        if (item.dataset.page === 'settings') {
            showCloudInfo();
        }
    });
});
    </script>
</body>
</html>
